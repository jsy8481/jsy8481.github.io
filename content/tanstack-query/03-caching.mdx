---
title: "03. 캐싱 전략"
description: "staleTime, gcTime 등 캐싱 옵션을 이해하고, 효율적인 데이터 관리 전략을 수립합니다."
date: "2026-02-16"
---

## 핵심 옵션

| 옵션 | 설명 | 기본값 |
|------|------|--------|
| `staleTime` | 데이터가 "신선(fresh)"한 시간. 이 시간 동안은 재요청하지 않음 | 0 |
| `gcTime` | 미사용 캐시를 메모리에 유지하는 시간 (Garbage Collection) | 5분 |
| `refetchOnWindowFocus` | 브라우저 탭이 다시 포커스될 때 재요청 | true |
| `refetchOnMount` | 컴포넌트가 마운트될 때 재요청 | true |

---

## staleTime vs gcTime 이해하기

```tsx
useQuery({
  queryKey: ['stocks'],
  queryFn: getStocks,
  staleTime: 1000 * 60 * 5,   // 5분간 신선 → 이 시간 동안 재요청 안 함
  gcTime: 1000 * 60 * 30,     // 30분간 캐시 유지 → 이후 메모리에서 삭제
});
```

**각 옵션의 의미:**

- `staleTime: 5분`: 데이터를 가져온 후 5분 동안은 "신선한" 상태입니다. 이 시간 동안 같은 쿼리를 실행하면 네트워크 요청 없이 캐시된 데이터를 바로 반환합니다.

- `gcTime: 30분`: 쿼리를 사용하는 컴포넌트가 모두 언마운트되면, 해당 캐시는 30분간 메모리에 유지됩니다. 30분 후에는 가비지 컬렉션되어 삭제됩니다.

```
┌─────────────────────────────────────────────────────────────────┐
│  시간선:  0분       5분(staleTime)        30분(gcTime)          │
│           │─────────│─────────────────────│                      │
│           │         │                     │                      │
│    상태:  Fresh     Stale                 Garbage Collected      │
│           │         │                     │                      │
│  동작:   캐시 즉시   refetch on access     캐시 완전 삭제         │
│          반환       (백그라운드 갱신)                             │
└─────────────────────────────────────────────────────────────────┘
```

**Fresh(신선) 상태에서:**
- 쿼리 실행 시 네트워크 요청 없이 캐시 데이터 즉시 반환

**Stale(오래된) 상태에서:**
- 캐시 데이터를 먼저 반환 (사용자는 즉시 화면을 봄)
- 백그라운드에서 새 데이터 요청
- 새 데이터 도착 시 UI 자동 업데이트

---

## 캐시 무효화 (Invalidation)

```tsx
const queryClient = useQueryClient();

// 1. 특정 쿼리 무효화 - 가장 일반적
// 'users'로 시작하는 모든 쿼리를 stale로 마킹하고 refetch
queryClient.invalidateQueries({ queryKey: ['users'] });

// 2. 정확한 키 매칭 - 특정 쿼리만 무효화
// ['users', 'user-123']만 무효화, ['users']는 영향 없음
queryClient.invalidateQueries({ 
  queryKey: ['users', userId], 
  exact: true 
});

// 3. 모든 쿼리 무효화 - 로그아웃 등에 사용
queryClient.invalidateQueries();
```

**언제 무효화를 사용하나요?**
- 데이터 생성/수정/삭제 후 목록을 새로고침할 때
- 사용자가 수동으로 "새로고침" 버튼을 클릭할 때
- 로그아웃 후 모든 사용자 관련 캐시를 정리할 때

---

## 수동 캐시 조작

```tsx
// 캐시에 직접 데이터 설정
// 서버 응답을 기다리지 않고 캐시를 즉시 업데이트 (낙관적 업데이트에 활용)
queryClient.setQueryData(['user', id], updatedUser);

// 캐시에서 데이터 읽기
// 현재 캐시된 값을 확인하거나 롤백에 사용
const cachedUser = queryClient.getQueryData(['user', id]);

// 캐시에서 데이터 제거
// 로그아웃 시 민감한 데이터 정리
queryClient.removeQueries({ queryKey: ['user'] });
```

---

## 권장 기본 설정

```tsx
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60,      // 1분: 대부분의 데이터에 적합
      gcTime: 1000 * 60 * 10,    // 10분: 메모리 효율과 UX 균형
      retry: 1,                   // 실패 시 1번만 재시도
      refetchOnWindowFocus: false, // 탭 전환마다 refetch 방지
    },
  },
});
```

**설정 이유:**
- `staleTime: 1분`: 빈번한 네트워크 요청을 방지하면서도 비교적 최신 데이터 유지
- `gcTime: 10분`: 잠시 다른 페이지 갔다가 돌아와도 캐시 유지
- `retry: 1`: 일시적 오류는 재시도하되, 무한 재시도 방지
- `refetchOnWindowFocus: false`: 탭 전환마다 요청하면 불필요한 트래픽 발생

---

## 레퍼런스

- [TanStack Query - Caching](https://tanstack.com/query/latest/docs/framework/react/guides/caching)
- [TanStack Query - Query Invalidation](https://tanstack.com/query/latest/docs/framework/react/guides/query-invalidation)

**다음 장**: [07. 통합 패턴](./07-integration-patterns.md)
