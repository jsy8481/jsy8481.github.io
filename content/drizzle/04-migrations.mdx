---
title: "04. ë§ˆì´ê·¸ë ˆì´ì…˜ (Migrations)"
description: "DB ìŠ¤í‚¤ë§ˆë¥¼ ì•ˆì „í•˜ê²Œ ë³€ê²½í•˜ê³  ì „íŒŒí•˜ëŠ” ì›Œí¬í”Œë¡œìš°ì…ë‹ˆë‹¤. íŒ€ ë‹¨ìœ„ í˜‘ì—…ê³¼ ë°°í¬ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë‹¤ë£¹ë‹ˆë‹¤."
date: "2026-02-16"
---

DB ìŠ¤í‚¤ë§ˆë¥¼ ì•ˆì „í•˜ê²Œ ë³€ê²½í•˜ê³  ì „íŒŒí•˜ëŠ” **"ì‹¤ë¬´ ì›Œí¬í”Œë¡œìš°"**ì…ë‹ˆë‹¤. ë‹¨ìˆœíˆ `push`í•˜ëŠ” ê²ƒì„ ë„˜ì–´, íŒ€ ë‹¨ìœ„ í˜‘ì—…ê³¼ ë°°í¬ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë‹¤ë£¹ë‹ˆë‹¤.

---

## âš™ï¸ 1. Drizzle Config ì„¤ì • (ì˜µì…˜ ìƒì„¸)

`drizzle.config.ts` íŒŒì¼ì€ ë§ˆì´ê·¸ë ˆì´ì…˜ ë„êµ¬ì˜ ê´€ì œíƒ‘ì…ë‹ˆë‹¤.

```typescript
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql', // 'mysql' | 'sqlite'
  schema: './src/db/schema', // ìŠ¤í‚¤ë§ˆ íŒŒì¼ ìœ„ì¹˜ (ê¸€ë¡œë¸Œ íŒ¨í„´ ê°€ëŠ¥ 'src/**/*.schema.ts')
  out: './drizzle', // ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼(.sql) ìƒì„± ìœ„ì¹˜
  
  // DB ì—°ê²° ì •ë³´ (ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ìš©)
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
  
  // â­ï¸ ì¤‘ìš” ì˜µì…˜ë“¤
  verbose: true,     // í„°ë¯¸ë„ì— ì‹¤í–‰ë˜ëŠ” SQL ì¶œë ¥
  strict: true,      // ë°ì´í„° ì†ì‹¤ ê²½ê³  ë¬´ì‹œ ë¶ˆê°€ (ì•ˆì „ì¥ì¹˜)
  tablesFilter: ['!private_*'], // íŠ¹ì • í…Œì´ë¸” ë¬´ì‹œ (ì˜ˆ: Supabase ë‚´ë¶€ í…Œì´ë¸”)
});
```

---

## ğŸ› ï¸ 2. í•µì‹¬ ëª…ë ¹ì–´ ìƒì„¸ ê°€ì´ë“œ

### `generate` (ì»¤ë°‹ ë§Œë“¤ê¸°)
ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì‚¬í•­ì„ ê°ì§€í•´ì„œ `.sql` íŒŒì¼ì„ ë§Œë“­ë‹ˆë‹¤. ê°€ì¥ ë§ì´ ì”ë‹ˆë‹¤.

```bash
# ê¸°ë³¸ ìƒì„±
npx drizzle-kit generate

# â­ï¸ ì‹ë³„í•˜ê¸° ì‰½ê²Œ ì´ë¦„ ë¶™ì´ê¸° (ì¶”ì²œ)
npx drizzle-kit generate --name add_user_phone
# -> drizzle/0001_add_user_phone.sql ìƒì„±ë¨
```

### `migrate` (ì»¤ë°‹ ë°˜ì˜í•˜ê¸°)
ìƒì„±ëœ `.sql` íŒŒì¼ë“¤ì„ ì‹¤ì œ DBì— ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
npx drizzle-kit migrate
```

### `custom` (ìˆ˜ë™ SQL ì‘ì„±)
Drizzle ORM ìŠ¤í‚¤ë§ˆë¡œ í‘œí˜„ ëª»í•˜ëŠ” ê²ƒë“¤(Trigger, Stored Procedure ë“±)ì„ ë§Œë“¤ ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

```bash
# ë¹ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„±
npx drizzle-kit generate --custom --name create_audit_trigger
```
ìƒì„±ëœ ë¹ˆ `xxxx_create_audit_trigger.sql` íŒŒì¼ì— ì§ì ‘ SQLì„ ì‘ì„±í•˜ë©´, ë‚˜ì¤‘ì— `migrate` í•  ë•Œ ê°™ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.

---

## ğŸš¨ 3. ë¬¸ì œ í•´ê²° (Troubleshooting)

### ìƒí™© 1: Drift (í‘œë¥˜) ğŸŒŠ
**"ëˆ„ê°€ ëª°ë˜ DBë¥¼ ìˆ˜ì •í–ˆì–´ìš”!"**
Drizzle ìŠ¤í‚¤ë§ˆì™€ ì‹¤ì œ DB ìƒíƒœê°€ ì•ˆ ë§ì„ ë•Œ ë°œìƒí•©ë‹ˆë‹¤. (ì˜ˆ: ëˆ„êµ°ê°€ Supabase ëŒ€ì‹œë³´ë“œì—ì„œ ì§ì ‘ ì»¬ëŸ¼ ì¶”ê°€í•¨)

1.  **ì§„ë‹¨**:
    ```bash
    npx drizzle-kit check
    # -> ì°¨ì´ì ì„ ë¦¬í¬íŠ¸ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.
    ```
2.  **í•´ê²° A (ì½”ë“œ ê¸°ì¤€ ë™ê¸°í™”)**:
    ë‹¤ì‹œ `push` í•˜ê±°ë‚˜ `generate`í•´ì„œ DBë¥¼ ë‚´ ì½”ë“œì— ë§ì¶¥ë‹ˆë‹¤. (DB ë³€ê²½ì‚¬í•­ ë®ì–´ì”€)
3.  **í•´ê²° B (DB ê¸°ì¤€ ë™ê¸°í™”)**:
    `introspect` (ë˜ëŠ” `pull`) ëª…ë ¹ì–´ë¡œ DB ìƒíƒœë¥¼ ìŠ¤í‚¤ë§ˆ íŒŒì¼ë¡œ ì—­ìƒì„±í•©ë‹ˆë‹¤.
    ```bash
    npx drizzle-kit pull
    ```

### ìƒí™© 2: ì¶©ëŒ (Conflicts) âš”ï¸
ë™ë£Œ Aì™€ Bê°€ ë™ì‹œì— ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì„ ë§Œë“¤ì–´ì„œ ì»¤ë°‹í–ˆìŠµë‹ˆë‹¤.
- `0005_add_post.sql` (A)
- `0005_add_comment.sql` (B)
ìˆœì„œ ë²ˆí˜¸ê°€ ê²¹ì³¤ë„¤ìš”!

**í•´ê²°**:
1. íŒŒì¼ ì´ë¦„ì˜ ìˆ«ìë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ (ìˆ˜ë™)
2. ê°€ì¥ ìµœì‹  ìŠ¤ëƒ…ìƒ·ì„ ì‚­ì œí•˜ê³  ë‹¤ì‹œ `generate` í•©ë‹ˆë‹¤.
3. Drizzle Kitì´ ì•Œì•„ì„œ ìˆœì„œë¥¼ ì¬ì¡°ì •í•˜ê¸°ë„ í•©ë‹ˆë‹¤. (ë²„ì „ì—…ë˜ë©´ì„œ ë˜‘ë˜‘í•´ì§)

---

## ğŸš€ 4. ë°°í¬ ì „ëµ (Production Deployment)

### ì•ˆì „í•œ ë°°í¬ ì¹˜íŠ¸ì‹œíŠ¸ CheckList âœ…

1.  **Schema Sync**: ë¡œì»¬ì—ì„œ `drizzle-kit generate` ì™„ë£Œ í›„ ì»¤ë°‹.
2.  **Dry Run**: ì‹¤ì œ ë°°í¬ ì „ í…ŒìŠ¤íŠ¸ DBì— ë¨¼ì € ì ìš©í•´ë´„.
3.  **Backup**: (ìš´ì˜ í™˜ê²½) ë°°í¬ ì§ì „ ìŠ¤ëƒ…ìƒ·/ë°±ì—… í•„ìˆ˜.
4.  **Auto Migrate**: ì„œë²„ ì‹œì‘ ì‹œ ìŠ¤í¬ë¦½íŠ¸ë¡œ ìë™ ì‹¤í–‰.

**NestJS ë“± ì„œë²„ ì½”ë“œì—ì„œ ìë™ ì‹¤í–‰í•˜ê¸°:**

```typescript
// src/db/migrate.ts
import { migrate } from 'drizzle-orm/postgres-js/migrator';
import { db } from './index';

async function main() {
  console.log('Migrating...');
  // 'drizzle' í´ë”ì˜ sql íŒŒì¼ë“¤ì„ ì½ì–´ì„œ ì‹¤í–‰
  await migrate(db, { migrationsFolder: './drizzle' });
  console.log('Done!');
}
main();
```

> **ì£¼ì˜**: ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—¬ëŸ¬ ê°œ(PM2 í´ëŸ¬ìŠ¤í„°, K8s íŒŒë“œ ë“±)ì¼ ë•Œ, ë™ì‹œì— `migrate`ê°€ ì‹¤í–‰ë˜ë©´ ë½(Lock) ê±¸ë¦¬ê±°ë‚˜ ê¼¬ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. **ë°°í¬ íŒŒì´í”„ë¼ì¸(CI/CD)ì˜ ë³„ë„ ë‹¨ê³„** ë¡œ ë¹¼ëŠ” ê²ƒì´ ê°€ì¥ ì•ˆì „í•©ë‹ˆë‹¤.

---

## ğŸ”— ë ˆí¼ëŸ°ìŠ¤
- [Drizzle Kit Config](https://orm.drizzle.team/docs/kit-conf)
- [Command References](https://orm.drizzle.team/docs/kit-overview)

**ë‹¤ìŒ ì¥**: [05. CRUD ì¡°ì‘ (CRUD Operations)](./05-crud-operations.md)
