---
title: "06. ê³ ê¸‰ ì¿¼ë¦¬ (Advanced Queries)"
description: "ì‹¤ë¬´ì—ì„œ ëŒ€ì‹œë³´ë“œ í†µê³„, ê²€ìƒ‰, í˜ì´ì§• ì²˜ë¦¬ë¥¼ êµ¬í˜„í•  ë•Œ í•„ìš”í•œ ê³ ê¸‰ ê¸°ìˆ ë“¤ì…ë‹ˆë‹¤."
date: "2026-02-16"
---

ì‹¤ë¬´ì—ì„œ ëŒ€ì‹œë³´ë“œ í†µê³„, ê²€ìƒ‰, í˜ì´ì§• ì²˜ë¦¬ë¥¼ êµ¬í˜„í•  ë•Œ í•„ìš”í•œ ê³ ê¸‰ ê¸°ìˆ ë“¤ì…ë‹ˆë‹¤.

---

## ğŸ“Š 1. ì§‘ê³„ì™€ ê·¸ë£¹í•‘ (Aggregation)

`count`, `sum`, `avg` ë“±ì˜ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

```typescript
import { count, sum, avg, desc } from 'drizzle-orm';

const result = await db
  .select({
    userId: posts.authorId,
    // count()ëŠ” ë¬¸ìì—´ë¡œ ë°˜í™˜ë  ìˆ˜ ìˆì–´ mapWith(Number)ë¡œ ë³€í™˜ ì¶”ì²œ
    postCount: count(posts.id).mapWith(Number), 
    totalViews: sum(posts.views).mapWith(Number),
  })
  .from(posts)
  .groupBy(posts.authorId) // ì‚¬ìš©ìë³„ë¡œ ë¬¶ê¸°
  .having(({ postCount }) => gt(postCount, 5)) // (Optional) ê¸€ 5ê°œ ì´ìƒ ì“´ ì‚¬ëŒë§Œ
  .orderBy(({ postCount }) => desc(postCount));
```

---

## ğŸï¸ 2. RQB ì‹¬í™”: ê³„ì‚°ëœ í•„ë“œ (Computed Fields)

Relational Query Builder(`db.query...`)ë¥¼ ì“°ë©´ì„œ, SQLë¡œ ê³„ì‚°í•œ ê°’ë„ ê°ì²´ì— í¬í•¨ì‹œí‚¤ê³  ì‹¶ë‹¤ë©´ `extras`ë¥¼ ì”ë‹ˆë‹¤.

```typescript
const usersWithStats = await db.query.users.findMany({
  extras: {
    // 1. ì†Œë¬¸ì ì´ë¦„ (SQL í•¨ìˆ˜ ì‹¤í–‰)
    lowerName: sql<string>`lower(${users.name})`.as('lower_name'),
    
    // 2. ì „ì²´ ê²Œì‹œê¸€ ìˆ˜ (ì„œë¸Œì¿¼ë¦¬)
    totalPosts: sql<number>`(
      SELECT count(*) FROM ${posts} WHERE ${posts.authorId} = ${users.id}
    )`.as('total_posts'),
  },
  with: {
    profile: true, // ê¸°ì¡´ ê´€ê³„ë„ ê°™ì´ ê°€ì ¸ì˜´
  },
});

console.log(usersWithStats[0].totalPosts); // ì‚¬ìš© ê°€ëŠ¥!
```

---

## ğŸ§© 3. ë™ì  ì¿¼ë¦¬ ë¹Œë”© (Dynamic Query Building)

ê²€ìƒ‰ í•„í„°ê°€ ìˆì„ ìˆ˜ë„ ìˆê³  ì—†ì„ ìˆ˜ë„ ìˆì„ ë•Œ(Optional Filters), ë°°ì—´ì„ í™œìš©í•´ ê¹”ë”í•˜ê²Œ ì§­ë‹ˆë‹¤.

```typescript
import { sql } from 'drizzle-orm';

async function searchUsers(keyword?: string, role?: string) {
  const filters = [];

  // ì¡°ê±´ì´ ìˆì„ ë•Œë§Œ í•„í„° ì¶”ê°€
  if (keyword) {
    filters.push(or(
      ilike(users.name, `%${keyword}%`),
      ilike(users.email, `%${keyword}%`)
    ));
  }
  
  if (role) {
    filters.push(eq(users.role, role));
  }
  
  // í™œì„± ì‚¬ìš©ìë§Œ
  filters.push(eq(users.isActive, true));

  return db.select()
    .from(users)
    .where(and(...filters)); // and() ì•ˆì— í¼ì³ ë„£ê¸°
}
```

---

## ğŸ“„ 4. í˜ì´ì§• (Pagination) ì²˜ë¦¬

### Offset Based (ê¸°ë³¸)
"1í˜ì´ì§€, 2í˜ì´ì§€..." ì§ê´€ì ì´ì§€ë§Œ ë’¤ë¡œ ê°ˆìˆ˜ë¡ ëŠë ¤ì§.
```typescript
const page = 1;
const limit = 10;

await db.query.users.findMany({
  limit: limit,
  offset: (page - 1) * limit,
  orderBy: desc(users.createdAt),
});
```

### Cursor Based (ë¬´í•œ ìŠ¤í¬ë¡¤, ê³ ì„±ëŠ¥)
"ë§ˆì§€ë§‰ìœ¼ë¡œ ë³¸ í•­ëª© ë‹¤ìŒë¶€í„°..." ëŒ€ìš©ëŸ‰ ë°ì´í„°ì— í•„ìˆ˜.
```typescript
const lastSeenId = 100; // í”„ë¡ íŠ¸ì—ì„œ ë°›ì€ ë§ˆì§€ë§‰ ì•„ì´í…œ ID
const lastSeenDate = '2023-01-01...';

await db.query.users.findMany({
  limit: 10,
  where: (users, { and, lt }) => and(
    // (ìƒì„±ì¼ < ë§ˆì§€ë§‰ë‚ ì§œ) OR (ìƒì„±ì¼ = ë§ˆì§€ë§‰ë‚ ì§œ AND ID < ë§ˆì§€ë§‰ID)
    // ë³µí•© ì¸ë±ìŠ¤ (createdAt, id) íƒœìš°ë©´ ì—„ì²­ ë¹ ë¦„ âš¡ï¸
    lt(users.createdAt, new Date(lastSeenDate)), 
  ),
  orderBy: desc(users.createdAt),
});
```

---

## ğŸ”— ë ˆí¼ëŸ°ìŠ¤
- [Relational Query Builder](https://orm.drizzle.team/docs/rqb)
- [Aggregations](https://orm.drizzle.team/docs/select#aggregations)
- [Pagination](https://orm.drizzle.team/docs/guides/limit-offset-pagination)

**ë‹¤ìŒ ì¥**: [07. Zod í†µí•© (Validation)](./07-zod-integration.md)
