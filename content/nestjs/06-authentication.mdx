---
title: "06. ì¸ì¦ ì²˜ë¦¬"
description: "ëˆ„ê°€ ìš”ì²­ì„ ë³´ëƒˆëŠ”ì§€(ì¸ì¦)ì™€ ê·¸ ìš”ì²­ì„ í—ˆë½í•  ê²ƒì¸ì§€(ì¸ê°€)ë¥¼ ì™„ë²½í•˜ê²Œ í†µì œí•˜ëŠ” Guard, Strategy, ê·¸ë¦¬ê³  ì»¤ìŠ¤í…€ ë°ì½”ë ˆì´í„° í™œìš©ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤."
date: "2026-02-26"
---

# ğŸ·ï¸ 06. ì¸ì¦ ì²˜ë¦¬ â€” ë‹¹ì‹ ì€ ëˆ„êµ¬ê³ , ì–´ë””ê¹Œì§€ ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ”ê°€?

## ğŸ“‹ ëª©ì°¨
- [ğŸ“Œ ì´ ë¬¸ì„œë¥¼ ì½ê¸° ì „ì—](#-ì´-ë¬¸ì„œë¥¼-ì½ê¸°-ì „ì—)
- [ğŸ¤” ì™œ ì•Œì•„ì•¼ í•˜ëŠ”ê°€](#-ì™œ-ì•Œì•„ì•¼-í•˜ëŠ”ê°€)
- [ğŸ—ï¸ ë¹„ìœ ë¡œ ë¨¼ì € ì´í•´í•˜ê¸°](#-ë¹„ìœ ë¡œ-ë¨¼ì €-ì´í•´í•˜ê¸°)
- [ğŸ§© ì¸ì¦ê³¼ ì¸ê°€ â€” ì ˆëŒ€ í—·ê°ˆë¦¬ë©´ ì•ˆ ë˜ëŠ” ë‘ ë‹¨ì–´ ğŸŸ¡](#-ì¸ì¦ê³¼-ì¸ê°€--ì ˆëŒ€-í—·ê°ˆë¦¬ë©´-ì•ˆ-ë˜ëŠ”-ë‘-ë‹¨ì–´-)
- [ğŸ§© JWT Strategyì™€ Guard â€” ì ë“¤ì§€ ì•ŠëŠ” ê²½ë¹„ì› ğŸŸ¢](#-jwt-strategyì™€-guard--ì ë“¤ì§€-ì•ŠëŠ”-ê²½ë¹„ì›-)
- [ğŸ§© ì»¤ìŠ¤í…€ ë°ì½”ë ˆì´í„° â€” ê²½ë¹„ì› ì¡°ì¢…í•˜ê¸° ğŸŸ¢](#-ì»¤ìŠ¤í…€-ë°ì½”ë ˆì´í„°--ê²½ë¹„ì›-ì¡°ì¢…í•˜ê¸°-)
- [ğŸ§ª ë”°ë¼í•´ë³´ê¸°: ì‹¤ì „ ì—­í•  ê¸°ë°˜ ì¸ê°€(RBAC) êµ¬í˜„](#-ë”°ë¼í•´ë³´ê¸°-ì‹¤ì „-ì—­í• -ê¸°ë°˜-ì¸ê°€rbac-êµ¬í˜„)
- [ğŸ’¼ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ì™€ ì‹¤ë¬´ íŒ](#-ë² ìŠ¤íŠ¸-í”„ë™í‹°ìŠ¤ì™€-ì‹¤ë¬´-íŒ)
- [ğŸ’¥ ì—ëŸ¬ í•´ê²° ì¹´íƒˆë¡œê·¸](#-ì—ëŸ¬-í•´ê²°-ì¹´íƒˆë¡œê·¸)
- [ğŸ—‚ï¸ ì¹˜íŠ¸ì‹œíŠ¸](#ï¸-ì¹˜íŠ¸ì‹œíŠ¸)
- [ğŸ“ ë§ˆë¬´ë¦¬ í€´ì¦ˆ](#-ë§ˆë¬´ë¦¬-í€´ì¦ˆ)

---

## ğŸ“Œ ì´ ë¬¸ì„œë¥¼ ì½ê¸° ì „ì—

**â±ï¸ ì˜ˆìƒ ì½ê¸° ì‹œê°„:** 20ë¶„ (ì „ì²´) / í•µì‹¬ íŒŒíŠ¸ë§Œ: 10ë¶„

**ğŸ§³ ì „ì œ ì§€ì‹ ì²´í¬ë¦¬ìŠ¤íŠ¸**
- [ ] JWT(JSON Web Token)ê°€ ë¬´ì—‡ì¸ì§€ ì•„ì£¼ ê°„ëµí•˜ê²Œë¼ë„ ì•Œê³  ìˆë‹¤.
- [ ] ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ëª¨ë“ˆê³¼ ë°ì½”ë ˆì´í„°ë¥¼ ë“±ë¡í•˜ëŠ” ë°©ë²•ì„ ì•ˆë‹¤.

**ğŸ—ºï¸ ì´ ë¬¸ì„œì˜ íë¦„**
ì¸ì¦/ì¸ê°€ ê°œë… ì •ë¦¬ â†’ Supabase ê¸°ë°˜ JWT ê²€ì¦ ì„¸íŒ… â†’ ê°€ë“œ(Guard)ë¡œ ë¬¸ë‹¨ì†í•˜ê¸° â†’ ë°ì½”ë ˆì´í„° ì§ì ‘ ë§Œë“¤ì–´ì„œ ìš°ì•„í•˜ê²Œ ì“°ê¸° â†’ ì‹¤ë¬´ íŒ & ì—ëŸ¬ ëŒ€ì²˜ë²•

**ğŸ¯ ì´ ë¬¸ì„œë¥¼ ë‹¤ ì½ìœ¼ë©´ í•  ìˆ˜ ìˆëŠ” ê²ƒ**
- [ ] ë©´ì ‘ê´€ì´ ë“¤ì–´ì™€ì„œ "ì¸ì¦ê³¼ ì¸ê°€ì˜ ì°¨ì´ëŠ”?" ì´ë¼ê³  ë¬¼ì–´ë´¤ì„ ë•Œ ë¹„ìœ ë¥¼ ë“¤ì–´ 10ì´ˆ ì•ˆì— ì„¤ëª…í•  ìˆ˜ ìˆë‹¤.
- [ ] ë‚´ API ì „ì²´ì— ë¬´ì  ë°©ì–´ë§‰(Guard)ì„ ì¹˜ê³ , íŠ¹ì • ë¼ìš°íŠ¸ë§Œ ì˜ˆì™¸ì ìœ¼ë¡œ ì—´ì–´ì¤„ ìˆ˜ ìˆë‹¤.
- [ ] `req.user` ëŒ€ì‹  `@CurrentUser()`ë¼ëŠ” ì»¤ìŠ¤í…€ ìŠ¤í‚¬ì„ ëšë”± ë§Œë“¤ì–´ ì“¸ ìˆ˜ ìˆë‹¤.

---

## ğŸ¤” ì™œ ì•Œì•„ì•¼ í•˜ëŠ”ê°€

ë°±ì—”ë“œ ì„œë²„ì˜ ê°€ì¥ ì¤‘ìš”í•œ ì„ë¬´ëŠ” 'ë°ì´í„°ë¥¼ ì§€í‚¤ëŠ” ê²ƒ'ì´ì•¼.
íšŒì›ê°€ì…/ë¡œê·¸ì¸ ë¡œì§ì´ì•¼ Supabase ê°™ì€ ì™¸ë¶€ íˆ´ì´ ëŒ€ì‹ í•´ì¤„ ìˆ˜ ìˆì§€ë§Œ,
"ì´ ìš”ì²­ì„ ë³´ë‚¸ ì‚¬ëŒì´ ì§„ì§œ ë¡œê·¸ì¸í•œ ìœ ì €ì¸ì§€?", "ì´ ìœ ì €ê°€ ê´€ë¦¬ìë§Œ ì‚­ì œí•  ìˆ˜ ìˆëŠ” ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ë ¤ê³  í•˜ëŠ” ê±´ ì•„ë‹Œì§€?"ë¥¼ ê²€ì‚¬í•˜ëŠ” ê±´ ì˜¨ì „íˆ ìš°ë¦¬ ë°±ì—”ë“œ ì„œë²„ì˜ ëª«ì´ê±°ë“ .
NestJSì˜ Guardì™€ Decoratorë¥¼ ì¡°í•©í•˜ë©´ ì´ ë³µì¡í•œ ê²€ì‚¬ ë¡œì§ì„ ìˆ˜ë°± ê°œì˜ ë¼ìš°í„°ì— ë‹¨ 1ì¤„ì˜ ì½”ë“œë¡œ ë—ë‹¤ ë¶™ì˜€ë‹¤ í•  ìˆ˜ ìˆì–´.

---

## ğŸ—ï¸ ë¹„ìœ ë¡œ ë¨¼ì € ì´í•´í•˜ê¸°

> ğŸ§’ **5ì‚´ì—ê²Œ ì„¤ëª…í•œë‹¤ë©´?**
> ê±°ëŒ€í•œ íšŒì‚¬ ê±´ë¬¼ì„ ìƒìƒí•´ ë³´ì.
> 
> **ì¸ì¦ (Authentication): "ì‹ ë¶„ì¦ ë°œê¸‰ê³¼ ì‹ ë¶„ì¦ ìœ„ì¡° ê²€ì‚¬"**
> ë¡œë¹„ì— ë“¤ì–´ì˜¨ ì‚¬ëŒì´ ì§ì›ì´ë¼ëŠ” ê±¸ ì¦ëª…(ë¡œê·¸ì¸ ì•„ì´ë””/ë¹„ë²ˆ)í•˜ë©´ 'ì‚¬ì›ì¦(JWT)'ì„ ë°œê¸‰í•´ì¤˜. ë§Œì•½ ì‚¬ì›ì¦ì„ ë“¤ê³  ì˜¤ë©´, ê²½ë¹„ì›(Guard)ì´ ì´ê²Œ ì§„ì§œ íšŒì‚¬ì—ì„œ ë°œê¸‰í•œ ì‚¬ì›ì¦ì´ ë§ëŠ”ì§€ í™€ë¡œê·¸ë¨(ì„œëª…)ì„ í™•ì¸í•´.
> 
> **ì¸ê°€ (Authorization): "ì¶œì… ê¶Œí•œ ê²€ì‚¬"**
> ì‚¬ì›ì¦ ê²€ì‚¬ì— í†µê³¼í–ˆì–´. ê·¸ëŸ°ë° ì´ ì§ì›ì´ ì‚¬ì›ì¦ì„ ì°ê³  'ì‚¬ì¥ì‹¤'ì´ë‚˜ 'ê¸°ë°€ë¬¸ì„œ ë³´ê´€ì‹¤' ë¬¸ì„ ì—´ë ¤ê³  í•´. ê²½ë¹„ì›ì´ ì§ì›ì˜ ì§ê¸‰(Role)ì„ í™•ì¸í•œ ë’¤ "ì–´í—ˆ, ì¼ë°˜ ì‚¬ì›ì€ ì—¬ê¸¸ ëª» ë“¤ì–´ê°‘ë‹ˆë‹¤" í•˜ê³  ë§‰ì•„ì„œëŠ” ê³¼ì •ì´ì•¼.

---

## ğŸ§© ì¸ì¦ê³¼ ì¸ê°€ â€” ì ˆëŒ€ í—·ê°ˆë¦¬ë©´ ì•ˆ ë˜ëŠ” ë‘ ë‹¨ì–´ ğŸŸ¡

> ğŸ¯ **ì´ ì„¹ì…˜ì„ ì½ê³  ë‚˜ë©´:** 
> - AuthNê³¼ AuthZë¥¼ ì™„ë²½í•˜ê²Œ ë¶„ë¦¬í•´ì„œ ì‚¬ê³ í•  ìˆ˜ ìˆë‹¤.

ì‹¤ë¬´ì—ì„œ ê°€ì¥ ë§ì´ í˜¼ìš©í•˜ëŠ” ë‹¨ì–´ Top 1ìœ„ì•¼. ì˜ì–´ë¡œëŠ” ì• ê¸€ìë¥¼ ë”°ì„œ **AuthN(ì¸ì¦)**, **AuthZ(ì¸ê°€)** ë¡œ ë§ì´ ì¤„ì—¬ì„œ ë¶€ë¥´ì§€.

| êµ¬ë¶„ | ì¸ì¦ (AuthN / Authentication) | ì¸ê°€ (AuthZ / Authorization) |
|------|-------------------------------|------------------------------|
| **í•µì‹¬ ì§ˆë¬¸** | "ë‹¹ì‹ ì€ ë„ëŒ€ì²´ **ëˆ„êµ¬**ì¸ê°€?" | "ë‹¹ì‹ ì´ **ì´ê±¸ í•´ë„ ë˜ëŠ”ê°€?**" |
| **ì‹¤íŒ¨ ì‹œ ì‘ë‹µ** | `401 Unauthorized` | `403 Forbidden` |
| **êµ¬í˜„ ìš”ì†Œ** | `passport-jwt`, `JwtStrategy` | `RolesGuard`, `@Roles('admin')` |

> ğŸ’¡ **ë¹„ë°€ë²ˆí˜¸ í•´ì‹±ì— ëŒ€í•˜ì—¬ (Supabase ì‚¬ìš© ì‹œ)**
> ë§Œì•½ DBì— ì§ì ‘ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì €ì¥í•œë‹¤ë©´ ë¬´ì¡°ê±´ `bcrypt` ê°™ì€ í•´ì‹± ì•Œê³ ë¦¬ì¦˜ì„ ì¨ì•¼ í•˜ì§€ë§Œ, ì§€ê¸ˆ ì´ êµ¬ì¡°ì—ì„œëŠ” Supabase Authê°€ ê·¸ ìœ„í—˜í•œ ì¼ë“¤ì„ ì „ë¶€ ëŒ€ì‹  ì²˜ë¦¬í•´ì£¼ê³  **ì•ˆì „í•œ JWT í† í°**ë§Œ ìš°ë¦¬ì—ê²Œ ë„˜ê²¨ì¤˜. ìš°ë¦° ê·¸ í† í°ì´ ìœ„ì¡°ë˜ì§€ ì•Šì•˜ëŠ”ì§€ë§Œ ê²€ì‚¬í•˜ë©´ ëì´ì•¼.

---

## ğŸ§© JWT Strategyì™€ Guard â€” ì ë“¤ì§€ ì•ŠëŠ” ê²½ë¹„ì› ğŸŸ¢

NestJSì—ì„œ ì´ ì‚¬ì›ì¦ ê²€ì‚¬ê¸°ë¥¼ ë“¤ì´ëŠ” ê³¼ì •ì„ ë³´ì. `passport`ë¼ëŠ” ìœ ëª…í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ í˜ì„ ë¹Œë¦´ ê±°ì•¼.

### 1. Strategy (ì „ëµ): "ì´ ì‹ ë¶„ì¦ì„ ì´ë ‡ê²Œ ê²€ì‚¬í•´ë¼"

```typescript
import { Injectable } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { ExtractJwt, Strategy } from 'passport-jwt';
import { passportJwtSecret } from 'jwks-rsa'; // Supabase ê³µê°œí‚¤ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•œ ë§ˆë²• ì§€íŒ¡ì´

@Injectable()
export class SupabaseJwtStrategy extends PassportStrategy(Strategy) {
  constructor(configService: ConfigService) {
    const supabaseUrl = configService.getOrThrow('SUPABASE_URL');
    
    super({
      // "ìš”ì²­ì„ ë³´ë‚¼ ë•Œ ë¨¸ë¦¬(Header)ì— Bearer ë¼ê³  ì íŒ ê³³ì—ì„œ í† í°ì„ êº¼ë‚´ì„¸ìš”"
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      ignoreExpiration: false, // ë§Œë£Œëœ í† í°ì€ ê°€ì°¨ì—†ì´ ì»·!
      
      // "Supabase ë³¸ì‚¬ì— ì—°ë½í•´ì„œ, ì´ í† í°ì´ ì§„ì§œ ì„œëª…ëœ ê²Œ ë§ëŠ”ì§€ ì¸ì¦í‚¤ë¥¼ ë°›ì•„ì˜¤ì„¸ìš”"
      secretOrKeyProvider: passportJwtSecret({
        cache: true,
        jwksUri: `${supabaseUrl}/auth/v1/.well-known/jwks.json`,
      }),
      algorithms: ['RS256'], // Supabaseê°€ ì“°ëŠ” ì•”í˜¸í™” ë°©ì‹
    });
  }

  // ğŸš¨ JWT í™€ë¡œê·¸ë¨ ê²€ì‚¬ê°€ í†µê³¼ë˜ë©´ ë§ˆì§€ë§‰ìœ¼ë¡œ ì´ í•¨ìˆ˜ê°€ ì‹¤í–‰ë¼!
  async validate(payload: any) {
    // ì—¬ê¸°ì„œ ë¦¬í„´í•˜ëŠ” ê°ì²´ê°€ ë°”ë¡œ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì“¸ ìˆ˜ ìˆëŠ” 'ìœ ì € ì •ë³´'ê°€ ë¼.
    return {
      id: payload.sub,
      email: payload.email,
      role: payload.app_metadata?.provider || 'user',
    };
  }
}
```

### 2. Guard (ê°€ë“œ): "ëª¨ë“  ë¬¸ì„ í‹€ì–´ë§‰ëŠ” ê²½ë¹„ì› ì„  ë°°ì¹˜"

ì „ëµì€ ì§°ìœ¼ë‹ˆ, ì´ì œ ì´ ì „ëµì„ ìˆ˜í–‰í•  ì§„ì§œ ê²½ë¹„ì›ì„ ë³µë„ë§ˆë‹¤ ì„¸ì›Œë³´ì.

```typescript
// auth/guards/jwt-auth.guard.ts
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class JwtAuthGuard extends AuthGuard('supabase-jwt') {
  // ì—ëŸ¬ ë°œìƒ ì‹œ ì»¤ìŠ¤í…€ ë©”ì‹œì§€ë¥¼ ë„ìš°ê³  ì‹¶ë‹¤ë©´ ìš” í•¨ìˆ˜ë¥¼ ì˜¤ë²„ë¼ì´ë”©í•´!
  handleRequest(err: any, user: any, info: any) {
    if (err || !user) {
      throw err || new UnauthorizedException('ì‚¬ì›ì¦(ë¡œê·¸ì¸)ì´ í•„ìš”í•©ë‹ˆë‹¤!');
    }
    return user; // ğŸ‘ˆ validate()ì—ì„œ ë¦¬í„´í–ˆë˜ ë°”ë¡œ ê·¸ ê°ì²´
  }
}
```

**[ì‹¤ë¬´ íŒ] ê¸€ë¡œë²Œë¡œ ê²½ë¹„ì› ê¹”ì•„ë²„ë¦¬ê¸°**
ë¼ìš°í„° ë°± ê°œë§ˆë‹¤ `@UseGuards(JwtAuthGuard)`ë¥¼ ë‹¬ë‹¤ ë³´ë©´ ê¼­ í•˜ë‚˜ì”© ë¹¼ë¨¹ì–´ì„œ ë³´ì•ˆ êµ¬ë©ì´ ë°œìƒí•´. ì°¨ë¼ë¦¬ "ê±´ë¬¼ ì „ì²´ë¥¼ íì‡„í•˜ê³ , í•„ìš”í•œ ê³³ë§Œ ì—´ì–´ì£¼ëŠ”" í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë°©ì‹ì´ ì‹¤ë¬´ì—ì„  ì •ì„ì´ì•¼.

```typescript
// app.module.ts
@Module({
  providers: [
    {
      provide: APP_GUARD,
      useClass: JwtAuthGuard, // ì´ë ‡ê²Œ í•˜ë©´ ë‹¨ 1ì¤„ë¡œ ë‚´ ì•±ì˜ ëª¨ë“  APIê°€ ë¡œê·¸ì¸ í•„ìˆ˜ê°€ ë¨!
    },
  ],
})
export class AppModule {}
```

---

## ğŸ§© ì»¤ìŠ¤í…€ ë°ì½”ë ˆì´í„° â€” ê²½ë¹„ì› ì¡°ì¢…í•˜ê¸° ğŸŸ¢

> ğŸ¯ **ì´ ì„¹ì…˜ì„ ì½ê³  ë‚˜ë©´:** 
> - ë‚˜ë§Œì˜ `@Public()` ë°ì½”ë ˆì´í„°ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.
> - ë‚˜ë§Œì˜ `@CurrentUser()` ë°ì½”ë ˆì´í„°ë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

ê±´ë¬¼ ì „ì²´ë¥¼ ì ê°€ë²„ë ¸ìœ¼ë‹ˆ, ë¡œê·¸ì¸ í™”ë©´ì´ë‚˜ ìƒí’ˆ êµ¬ê²½ í™”ë©´ ê°™ì´ **"í† í° ì—†ì–´ë„ ì ‘ì†í•´ì•¼ í•˜ëŠ” ê³³"** ì— êµ¬ë©ì„ ëš«ì–´ì¤˜ì•¼ê² ì§€?
"ê²½ë¹„ì› ì•„ì €ì”¨, ì´ ë¬¸ ì•ì—ëŠ” ì´ ìŠ¤í‹°ì»¤ê°€ ë¶™ì–´ìˆìœ¼ë©´ ê± í†µê³¼ì‹œì¼œì£¼ì„¸ìš”" ë¼ê³  ì¨ ë¶™ì¼ ìŠ¤í‹°ì»¤ë¥¼ ì§ì ‘ ë§Œë“¤ì–´ë³¼ê²Œ. ì´ê²ƒì´ ë°”ë¡œ ì»¤ìŠ¤í…€ ë°ì½”ë ˆì´í„°ì•¼.

### 1. `@Public()`: ë¬´ì‚¬í†µê³¼ ìŠ¤í‹°ì»¤ ë§Œë“¤ê¸°

```typescript
// decorators/public.decorator.ts
import { SetMetadata } from '@nestjs/common';

// 'isPublic' ì´ë¼ëŠ” ë¼ë²¨ì— trueë¼ëŠ” ê°’ì„ ì°ì–´ë‚´ëŠ” ìŠ¤í‹°ì»¤ë¥¼ ë§Œë“¤ì—ˆìŒ!
export const IS_PUBLIC_KEY = 'isPublic';
export const Public = () => SetMetadata(IS_PUBLIC_KEY, true);
```

ì´ì œ ì•„ê¹Œ ë§Œë“  ê²½ë¹„ì›(`JwtAuthGuard`)ì—ê²Œ ì´ ìŠ¤í‹°ì»¤ë¥¼ ë³´ëŠ” ëˆˆì„ ë‹¬ì•„ì£¼ì.

```typescript
// auth/guards/jwt-auth.guard.ts
import { Reflector } from '@nestjs/core'; // ìŠ¤í‹°ì»¤ íŒë³„ê¸°

@Injectable()
export class JwtAuthGuard extends AuthGuard('supabase-jwt') {
  constructor(private reflector: Reflector) { super(); }

  canActivate(context: ExecutionContext) {
    // 1. ë°©ê¸ˆ ìš”ì²­ì´ ë“¤ì–´ì˜¨ ë¼ìš°í„°ì— 'isPublic' ìŠ¤í‹°ì»¤ê°€ ë¶™ì–´ìˆëŠ”ì§€ í™•ì¸!
    const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
      context.getHandler(),
      context.getClass(),
    ]);
    
    // 2. ìŠ¤í‹°ì»¤ê°€ ìˆìœ¼ë©´ ì‹ ë¶„ì¦ ê²€ì‚¬(JWT ê²€ì‚¬) ìŠ¤í‚µ í›„ í†µê³¼!
    if (isPublic) return true;
    
    // 3. ìŠ¤í‹°ì»¤ê°€ ì—†ìœ¼ë©´ ì–„ì§¤ì—†ì´ ì›ë˜ í•˜ë˜ ì‹ ë¶„ì¦ ê²€ì‚¬ ì§„í–‰
    return super.canActivate(context);
  }
}
```

ì´ì œ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì´ë ‡ê²Œ ì“¸ ìˆ˜ ìˆì–´.
```typescript
@Get('health')
@Public() // ğŸ‘ˆ ë¡œê·¸ì¸ ì•ˆí•´ë„ ì ‘ì† ê°€ëŠ¥!
checkHealth() { return 'OK'; }
```

### 2. `@CurrentUser()`: ìœ ì € ì •ë³´ í¸í•˜ê²Œ ë¹¼ì˜¤ê¸°

ì›ë˜ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ìœ ì € ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ë ¤ë©´ `@Req() req`ë¥¼ í†µì§¸ë¡œ ê°€ì ¸ì™€ì„œ `req.user.id`ë¡œ ì ‘ê·¼í•´ì•¼ í•´. ë„ˆë¬´ ê·€ì°®ê³  ì§€ì €ë¶„í•˜ì§€.
ìš”ì²­ ê°ì²´ ê¹Šìˆ™ì´ ìˆ¨ì–´ìˆëŠ” user ì •ë³´ë§Œ ì™ì™ ë½‘ì•„ì£¼ëŠ” ê¸°ê³„ë¥¼ ë§Œë“¤ì.

```typescript
// decorators/current-user.decorator.ts
import { createParamDecorator, ExecutionContext } from '@nestjs/common';

export const CurrentUser = createParamDecorator(
  (data: unknown, ctx: ExecutionContext) => {
    const request = ctx.switchToHttp().getRequest();
    // ì‹ ë¶„ì¦ ê²€ì‚¬ë¥¼ í†µê³¼í•˜ë©° ì €ì¥ëœ ìœ ì € ì •ë³´ë¥¼ ëŒë ¤ì¤Œ
    return request.user; 
  },
);

// ------------ ì‚¬ìš© ì”¬ ------------
@Get('my-profile')
// ğŸ‘ˆ ê¹”ã…¡ë”
getProfile(@CurrentUser() user: { id: string; email: string }) { 
  return this.usersService.findOne(user.id);
}
```

---

## ğŸ§ª ë”°ë¼í•´ë³´ê¸°: ì‹¤ì „ ì—­í•  ê¸°ë°˜ ì¸ê°€(RBAC) êµ¬í˜„

ë§ˆì§€ë§‰ í•˜ì´ë¼ì´íŠ¸. ì‹ ë¶„ì¦ ê²€ì‚¬(AuthN)ëŠ” í†µê³¼í–ˆëŠ”ë°, ê·¸ ì§ì›ì´ ì¼ë°˜ ì‚¬ì›ì¸ì§€ ê´€ë¦¬ì(Admin)ì¸ì§€ ê²€ì‚¬í•´ì„œ **ì¸ê°€(AuthZ)** ë¥¼ ë•Œë ¤ë³´ì.
ì´ê²ƒë„ `@Roles('admin')` ìŠ¤í‹°ì»¤ë¥¼ ë§Œë“¤ê³ , ê·¸ê±¸ ê°ì‹œí•˜ëŠ” 2ë²ˆì§¸ ê²½ë¹„ì›ì„ ì„¸ìš°ë©´ ëë‚˜!

**1. ê¶Œí•œ ìŠ¤í‹°ì»¤ ë§Œë“¤ê¸°**
```typescript
export const ROLES_KEY = 'roles';
// ê´„í˜¸ ì•ˆì— ì ì€ ë¬¸ìì—´ë“¤('admin', 'user')ì„ í†µì§¸ë¡œ ë°°ì—´ë¡œ ì €ì¥!
export const Roles = (...roles: string[]) => SetMetadata(ROLES_KEY, roles);
```

**2. ê¶Œí•œ ê²½ë¹„ì›(RolesGuard) ì„¸ìš°ê¸°**
```typescript
@Injectable()
export class RolesGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    // 1. ì´ ì»¨íŠ¸ë¡¤ëŸ¬ì— ë“¤ì–´ì˜¤ê¸° ìœ„í•´ í•„ìš”í•œ ê¶Œí•œ ìŠ¤í‹°ì»¤ ëª©ë¡ì„ ê°€ì ¸ì™€
    const requiredRoles = this.reflector.getAllAndOverride<string[]>(ROLES_KEY, [
        context.getHandler(),
        context.getClass(),
    ]);
    
    // 2. ì•„ë¬´ ê¶Œí•œ ìŠ¤í‹°ì»¤ ì•ˆ ë¶™ì–´ìˆìœ¼ë©´ í†µê³¼ (Public ê°™ì€ ê³³)
    if (!requiredRoles) return true;
    
    // 3. ìœ ì €ì˜ ì‹ ë¶„ì¦ì—ì„œ ì§ê¸‰(role)ì„ êº¼ë‚´
    const { user } = context.switchToHttp().getRequest();
    
    // 4. ìœ ì € ê¶Œí•œì´ í•„ìš”í•œ ê¶Œí•œ ë°°ì—´ì— ì†í•´ìˆëŠ”ì§€ ê²€ì‚¬!
    return requiredRoles.includes(user.role);
  }
}
```

**3. ê¸€ë¡œë²Œ ê²½ë¹„ì› + ì»¨íŠ¸ë¡¤ëŸ¬ ì ìš©**
```typescript
// app.module.ts (ê²½ë¹„ì›ì€ 1ë²ˆ ê°€ë“œë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ê²€ì‚¬í•´)
providers: [
  { provide: APP_GUARD, useClass: JwtAuthGuard }, // 1. ë„ˆ ë¡œê·¸ì¸ í–ˆì–´?
  { provide: APP_GUARD, useClass: RolesGuard },   // 2. ë„ˆ ê´€ë¦¬ì ì§ê¸‰ ë§ì•„?
]

// ì»¨íŠ¸ë¡¤ëŸ¬
@Delete(':id')
@Roles('admin') // ğŸ‘ˆ ê´€ë¦¬ìë§Œ ì‚­ì œ ê°€ëŠ¥
remove(@Param('id') id: string) { ... }
```

---

## ğŸ’¼ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ì™€ ì‹¤ë¬´ íŒ ğŸŸ¡

### íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ì˜ Request ê°ì²´ íƒ€ì… í™•ì¥í•˜ê¸°
ë§¤ë²ˆ `req.user`ë¥¼ ì“¸ ë•Œë§ˆë‹¤ TypeScriptê°€ "Request ì•ˆì— userê°€ ì–´ë”¨ì–´ íƒ€ì… ì—ëŸ¬ì•¼!" ë¼ê³  í™”ë‚¼ ê±°ì•¼. ì–´ì©” ìˆ˜ ì—†ì´ `(req as any).user` ë¡œ í‰ì¹˜ì§€ ë§ê³ , ê·¼ë³¸ì ì¸ íƒ€ì…ì„ ë„“í˜€ì¤˜.

```typescript
// src/types/express.d.ts (íŒŒì¼ì„ ìƒˆë¡œ í•˜ë‚˜ ë§Œë“¤ì–´)
declare namespace Express {
  export interface Request {
    user?: User; // ë„¤ê°€ í”„ë¡œì íŠ¸ì—ì„œ ì“°ëŠ” User íƒ€ì…ì„ ê½‚ì•„ë„£ìœ¼ë©´ ë¼!
  }
}
```

### ì„ íƒì  ì¸ì¦ ê°€ë“œ (Optional Auth)
"ë¹„íšŒì›ì´ë©´ ì¼ë°˜ ê¸€ëª©ë¡ ë³´ì´ê³ , ë¡œê·¸ì¸í•œ íšŒì›ì´ë©´ ì¶”ì²œ ê¸€ëª©ë¡ë„ ì„ì—¬ì„œ ë³´ì´ëŠ”" ê²Œì‹œíŒ APIë¥¼ ë§Œë“¤ ë•Œ ì“°ëŠ” ê¼¼ìˆ˜ ê°€ë“œ.
ë¡œê·¸ì¸ì„ ì•ˆ í–ˆì–´ë„ 401 ì—ëŸ¬ë¥¼ íŠ•ê¸°ì§€ ì•Šê³  `null`ì„ ë„˜ê²¨ì£¼ê²Œ ì¡°ì‘í•´!

```typescript
@Injectable()
export class OptionalJwtAuthGuard extends AuthGuard('supabase-jwt') {
  handleRequest(err: any, user: any) {
    // ì—ëŸ¬ë¥¼ ë‚´ë¿œì§€ ì•Šê³  ê·¸ëƒ¥ null ë¦¬í„´
    return user || null; 
  }
}
```

---

## ğŸ’¥ ì—ëŸ¬ í•´ê²° ì¹´íƒˆë¡œê·¸

> ì—ëŸ¬ ë©”ì‹œì§€ê°€ ëœ¨ë©´ Ctrl+Fë¡œ ê²€ìƒ‰í•´ë´.

### âŒ `401 Unauthorized - JwtStrategy validation failed`

**í˜„ìƒ:**
```json
{ "statusCode": 401, "message": "Unauthorized" }
```
**ì›ì¸:** 
í´ë¼ì´ì–¸íŠ¸ê°€ í—¤ë”ì— `Authorization: Bearer <token>` ì„ ì œëŒ€ë¡œ ì•ˆ ë³´ëƒˆê±°ë‚˜, í† í° ê¸°í•œì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜, í† í°ì˜ ì„œëª…(Signature)ì´ ë³€ì¡°ë˜ì—ˆì„ ë•Œ!
**í•´ê²°ì±…:** 
í´ë¼ì´ì–¸íŠ¸ í”„ë¡ íŠ¸ ê°œë°œìì—ê²Œ "ìŠ¤í† ë¦¬ì§€ì—ì„œ í† í° êº¼ë‚´ì„œ í—¤ë”ì— ì˜ ë„£ì–´ë‹¬ë¼"ê³  ìš”ì²­í•´. í˜¹ì‹œ í† í°ì´ ë§Œë£Œë˜ì—ˆë‹¤ë©´ Refresh Tokenì„ ëŒë¦¬ëŠ” ë¡œì§ì´ í”„ë¡ íŠ¸ì— êµ¬ë¹„ë˜ì–´ì•¼ í•´.

### âŒ `403 Forbidden` ë°œìƒ

**í˜„ìƒ:**
ë¡œê·¸ì¸ì€ ì˜ ë˜ì–´ ë‚´ ì •ë³´ ì¡°íšŒëŠ” ë˜ëŠ”ë°, ì‚­ì œ APIë§Œ ëˆ„ë¥´ë©´ 403ì´ ëœ¸.
**ì›ì¸:** 
ê²½ë¹„ì› 1ë²ˆ(`JwtAuthGuard`)ì€ í†µê³¼í–ˆìœ¼ë‚˜, 2ë²ˆ(`RolesGuard`)ì—ì„œ ë§‰í˜. ë‚´ í† í°ì— ì°í˜€ìˆëŠ” `role` í”„ë¡œí¼í‹°ê°€ `"user"` ì¸ë° ë°±ì—”ë“œëŠ” `@Roles('admin')`ì„ ìš”êµ¬í•˜ê³  ìˆìŒ.
**í•´ê²°ì±…:** 
ì •ìƒì ì¸ ë°©ì–´ ì‹¤íŒ¨ í™”ë©´. ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì•¼ í•¨.

---

## ğŸ—‚ï¸ ì¹˜íŠ¸ì‹œíŠ¸ â€” ì‹¤ë¬´ ìš”ì•½ ì¹´ë“œ

| ìƒí™© | ì‚¬ìš© íŒ¨í„´ | ì„¤ëª… |
|------|-----------|------|
| **í† í°ì—ì„œ ì •ë³´ ë¹¼ë‚´ê¸°** | `jwtFromRequest: ExtractJwt...` | Strategy ë‚´ë¶€ ë¬¸ë²• |
| **ë¡œê·¸ì¸ í•„ìˆ˜ (ê°œë³„)** | `@UseGuards(JwtAuthGuard)` | ì»¨íŠ¸ë¡¤ëŸ¬/ë©”ì„œë“œì— ë¶€ì°© |
| **ë¡œê·¸ì¸ íŒ¨ìŠ¤ (ì˜ˆì™¸)** | `@Public()` | ì „ì—­ ê°€ë“œ ëš«ê¸° ìŠ¤í‹°ì»¤ |
| **ìœ ì € ì •ë³´ ë½‘ê¸°** | `@CurrentUser() user` | ì»¤ìŠ¤í…€ íŒŒë¼ë¯¸í„° í…Œì½”ë ˆì´í„° |
| **ê´€ë¦¬ì ì „ìš© ì„¤ì •** | `@Roles('admin', 'super')` | ì¸ê°€(AuthZ) ìŠ¤í‹°ì»¤ |

---

## ğŸ“ ë§ˆë¬´ë¦¬ í€´ì¦ˆ

**Q1. ë‹¹ì‹ ì´ ê°œë°œ ì¤‘ì¸ `deleteAccount` APIë¥¼ í˜¸ì¶œí•œ ìœ ì €ê°€ ì¸ì¦ í† í°(ì‚¬ì›ì¦) ì—†ì´ ë¬´ë‹¨ ì¹¨ì…ì„ ì‹œë„í–ˆë‹¤. ì´ë•Œ NestJSì˜ ë°±ì—”ë“œ ê²½ë¹„ì›(JwtAuthGuard)ì´ ë°˜í™˜í•´ì•¼ í•˜ëŠ” HTTP ìƒíƒœ ì½”ë“œì™€ ë‹¨ì–´ëŠ” ë¬´ì—‡ì¸ê°€?**

- A) 400 Bad Request
- B) 401 Unauthorized
- C) 403 Forbidden
- D) 404 Not Found

> âœ… **ì •ë‹µ: B**
> **ì„¤ëª…:** ì‹ ë¶„ì¦ ìì²´ê°€ ì—†ê±°ë‚˜ ìœ„ì¡°ëœ ìƒíƒœ. ì¦‰ "ë‹¹ì‹  ëˆ„êµ°ì§€ ëª°ë¼(Un-**auth**enticated)!" ìƒí™©ì´ë¯€ë¡œ 401ì´ì•¼. 403ì€ ì‹ ë¶„ì¦ì€ ì§„ì§œì—¬ì„œ ë“¤ë ¤ëŠ” ë³´ëƒˆëŠ”ë°, ê·¸ ë°©ì— ë“¤ì–´ê°ˆ ê¶Œí•œ ì§ê¸‰ì´ ì•„ë‹ ë•Œ(ì¸ê°€ ì‹¤íŒ¨) ë„ìš°ëŠ” ê±° ê¸°ì–µí•˜ì!

**Q2. `UseGuards(JwtAuthGuard)`ë¥¼ ëª¨ë“  ì»¨íŠ¸ë¡¤ëŸ¬ ìƒë‹¨ì— ì¼ì¼ì´ ë³µì‚¬+ë¶™ì—¬ë„£ê¸° í•˜ì§€ ì•Šê³ , í•œ ë²ˆì˜ ì„¤ì •ë§Œìœ¼ë¡œ í”„ë¡œì íŠ¸ ë‚´ì˜ ëª¨ë“  APIë¥¼ ì ê°€ë²„ë¦´ ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì„¤ëª…í•´ë´.**

> âœ… **ì •ë‹µ:** ë£¨íŠ¸ ëª¨ë“ˆì¸ `app.module.ts`ì˜ `providers` ë°°ì—´ ì•ˆì— `{ provide: APP_GUARD, useClass: JwtAuthGuard }` ë¥¼ ë“±ë¡í•˜ë©´ ì „ì—­ìœ¼ë¡œ í™œì„±í™”ë¼!

**Q3. ë””ë²„ê¹… í€´ì¦ˆ: ì•¼ì‹¬ ì°¨ê²Œ `@CurrentUser()` ë°ì½”ë ˆì´í„°ë¥¼ ë§Œë“¤ê³  ì•„ë˜ì²˜ëŸ¼ ì»¨íŠ¸ë¡¤ëŸ¬ì— ë‹¬ì•˜ë‹¤. ê·¸ëŸ°ë° `user` ë³€ìˆ˜ê°€ ìê¾¸ `undefined`ë¡œ ë–¨ì–´ì§„ë‹¤. ì´ìœ ê°€ ë­˜ê¹Œ?**

```typescript
@Get('my-data')
// (ì•—, ë­”ê°€ ë¹ ì¡Œë‹¤..!)
getMyData(@CurrentUser() user: any) {
  return this.service.getData(user.id);
}
```

> âœ… **ì •ë‹µ:** ì „ì—­ ê°€ë“œë¥¼ ê¹”ì§€ ì•Šì€ ìƒíƒœë¼ë©´, ì´ ë¼ìš°í„°ì— `@UseGuards(JwtAuthGuard)`ë¥¼ ì•ˆ ë‹¬ì•„ì¤˜ì„œ ê·¸ë˜!
> **ì„¤ëª…:** ë°±ì—”ë“œì— ì‹ ë¶„ì¦(í† í°) ì¡°ì°¨ ë“¤ì´ë°€ ì—¬ì§€ë¥¼ ì•ˆ ì¤€ ì±„ ê·¸ëƒ¥ ì»¨íŠ¸ë¡¤ëŸ¬ë¡œ í”„ë¦¬íŒ¨ìŠ¤ ì…ì¥í•´ë²„ë ¸ì–´. ì• ì´ˆì— ì‹ ë¶„ì¦ ê²€ì‚¬ë¥¼ í•˜ëŠ” ê²½ë¹„ì›(JwtStrategy)ì´ ë™ì‘í•´ì•¼ `req.user` ê°ì²´ê°€ ìƒê²¨ë‚˜ëŠ”ë°, ê²½ë¹„ì›ì´ ì—†ìœ¼ë‹ˆ ë‹¹ì—°íˆ ë½‘ì•„ì˜¬ `user`ë„ `undefined` ìƒíƒœì¸ ê±°ì§€. ë¡œê·¸ì¸ ì „ì œ ë¼ìš°í„°ì—ëŠ” ë°˜ë“œì‹œ ê°€ë“œë¥¼ ê¹”ì.

---

## ğŸ”— ë” ì•Œì•„ë³´ê¸°
- [NestJS - Authentication (ê³µì‹ ì „ëµ ì„¤ëª…)](https://docs.nestjs.com/security/authentication)
- [NestJS - Authorization (ì¸ê°€ ë° Role)](https://docs.nestjs.com/security/authorization)
- [07. ì „ì—­ ì˜ˆì™¸ ì²˜ë¦¬ (Exception Filters) ê°€ì´ë“œ](./07-error-handling.mdx)
