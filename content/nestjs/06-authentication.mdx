---
title: "06. ì¸ì¦ ì²˜ë¦¬"
description: "ì¸ì¦(Authentication)ê³¼ ì¸ê°€(Authorization)ì˜ ì°¨ì´ë¥¼ ì´í•´í•˜ê³ , JWT ê¸°ë°˜ ì¸ì¦ ì²˜ë¦¬ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤."
date: "2026-02-16"
---

## NestJS ì¸ì¦ ê°œìš”

### ì¸ì¦ vs ì¸ê°€

| êµ¬ë¶„ | ì¸ì¦ (Authentication) | ì¸ê°€ (Authorization) |
|------|----------------------|---------------------|
| **ì§ˆë¬¸** | "ë‹¹ì‹ ì€ ëˆ„êµ¬ì¸ê°€?" | "ë‹¹ì‹ ì€ ê¶Œí•œì´ ìˆëŠ”ê°€?" |
| **êµ¬í˜„** | Guard + Strategy | Guard + ë°ì½”ë ˆì´í„° |
| **ì˜ˆì‹œ** | ë¡œê·¸ì¸, JWT ê²€ì¦ | ê´€ë¦¬ìë§Œ ì ‘ê·¼ í—ˆìš© |

### NestJS ì¸ì¦ íë¦„

```
ìš”ì²­ â†’ Guard â†’ Strategy â†’ User ê°ì²´ ì£¼ì… â†’ Controller
          â”‚         â”‚
          â”‚         â””â”€â”€ í† í° ê²€ì¦, ì‚¬ìš©ì ì¡°íšŒ
          â””â”€â”€ ì¸ì¦ í•„ìš” ì—¬ë¶€ íŒë‹¨
```

---

## ë¹„ë°€ë²ˆí˜¸ í•´ì‹± (Password Hashing)

> **Note**: ì´ í”„ë¡œì íŠ¸ëŠ” **Supabase Auth** ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ, ë¹„ë°€ë²ˆí˜¸ í•´ì‹±ê³¼ ê²€ì¦ì€ Supabase ë‚´ë¶€ì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
> ë§Œì•½ ë¡œì»¬ ì¸ì¦(Local Strategy)ì„ êµ¬í˜„í•œë‹¤ë©´, `bcrypt` ë“±ì„ ì‚¬ìš©í•˜ì—¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°˜ë“œì‹œ í•´ì‹±í•´ì„œ ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.

```bash
npm install bcrypt
npm install -D @types/bcrypt
```

---

## Supabase Auth ì—°ë™

### JWT Strategy êµ¬í˜„

Supabaseì—ì„œ ë°œê¸‰í•œ JWTë¥¼ NestJSì—ì„œ ê²€ì¦í•©ë‹ˆë‹¤.

```typescript
// auth/strategies/supabase-jwt.strategy.ts
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { PassportStrategy } from '@nestjs/passport';
import { ExtractJwt, Strategy } from 'passport-jwt';
import { passportJwtSecret } from 'jwks-rsa';

@Injectable()
export class SupabaseJwtStrategy extends PassportStrategy(Strategy) {
  constructor(private readonly configService: ConfigService) {
    const supabaseUrl = configService.getOrThrow<string>('SUPABASE_URL');
    
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      ignoreExpiration: false,
      secretOrKeyProvider: passportJwtSecret({
        cache: true,
        rateLimit: true,
        jwksRequestsPerMinute: 5,
        jwksUri: `${supabaseUrl}/auth/v1/.well-known/jwks.json`,
      }),
      audience: 'authenticated',
      issuer: `${supabaseUrl}/auth/v1`,
      algorithms: ['RS256'],
    });
  }

  async validate(payload: any) {
    return {
      id: payload.sub,
      email: payload.email,
      role: payload.app_metadata?.provider || 'user', // Supabase app_metadata í™œìš©
    };
  }
}
```

### ğŸ” ì½”ë“œ ë¶„ì„
| ì½”ë“œ | ì„¤ëª… |
|------|------|
| `@Injectable()` | `SupabaseJwtStrategy`ë¥¼ Providerë¡œ ë“±ë¡í•©ë‹ˆë‹¤. |
| `PassportStrategy(Strategy)` | Passport ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ JWT Strategyë¥¼ ìƒì†ë°›ìŠµë‹ˆë‹¤. |
| `jwtFromRequest` | HTTP ìš”ì²­ì˜ **Authorization í—¤ë”**(`Bearer <token>`)ì—ì„œ JWTë¥¼ ì¶”ì¶œí•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤. |
| `passportJwtSecret` | JWT ì„œëª…ì„ ê²€ì¦í•˜ê¸° ìœ„í•´ Supabaseì˜ ê³µê°œí‚¤(JWKS)ë¥¼ ë™ì ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤. |
| `validate(payload)` | JWT ê²€ì¦ì´ ì„±ê³µí•˜ë©´ í˜¸ì¶œë©ë‹ˆë‹¤. ë°˜í™˜ê°’(`request.user`)ì€ ì´í›„ ì»¨íŠ¸ë¡¤ëŸ¬ ë“±ì—ì„œ `@CurrentUser()`ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. |




### Auth Module

```typescript
// auth/auth.module.ts
import { Module } from '@nestjs/common';
import { PassportModule } from '@nestjs/passport';
import { SupabaseJwtStrategy } from './strategies/supabase-jwt.strategy';

@Module({
  imports: [
    PassportModule.register({ defaultStrategy: 'supabase-jwt' }),
  ],
  providers: [SupabaseJwtStrategy],
  exports: [PassportModule],
})
export class AuthModule {}
```

---

## Guard êµ¬í˜„

### JWT Auth Guard

```typescript
// auth/guards/jwt-auth.guard.ts
import { Injectable, ExecutionContext, UnauthorizedException } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';
import { Reflector } from '@nestjs/core';
import { IS_PUBLIC_KEY } from '../decorators/public.decorator';

@Injectable()
export class JwtAuthGuard extends AuthGuard('supabase-jwt') {
  constructor(private reflector: Reflector) {
    super();
  }

  // ì¸ì¦ì´ í•„ìš”í•œì§€ íŒë‹¨
  canActivate(context: ExecutionContext) {
    // @Public() ë°ì½”ë ˆì´í„°ê°€ ìˆìœ¼ë©´ ì¸ì¦ ê±´ë„ˆë›°ê¸°
    const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
      context.getHandler(),
      context.getClass(),
    ]);
    
    if (isPublic) {
      return true;  // ê³µê°œ ë¼ìš°íŠ¸
    }
    
    return super.canActivate(context);  // JWT ê²€ì¦ ì‹¤í–‰
  }

  // ì¸ì¦ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì²˜ë¦¬
  handleRequest(err: any, user: any, info: any) {
    if (err || !user) {
      throw err || new UnauthorizedException('ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤');
    }
    return user;
  }
}
```

### ğŸ” ì½”ë“œ ë¶„ì„
| ì½”ë“œ | ì„¤ëª… |
|------|------|
| `canActivate` | ìš”ì²­ì´ ë“¤ì–´ì˜¬ ë•Œë§ˆë‹¤ ê°€ì¥ ë¨¼ì € ì‹¤í–‰ë˜ì–´ **ì ‘ê·¼ í—ˆìš© ì—¬ë¶€(true/false)** ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. |
| `this.reflector.getAllAndOverride` | í•¸ë“¤ëŸ¬ë‚˜ í´ë˜ìŠ¤ì— ì„¤ì •ëœ ë©”íƒ€ë°ì´í„°(`@Public`)ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤. ë©”ì„œë“œ ë ˆë²¨ ì„¤ì •ì´ ìš°ì„ ìˆœìœ„ë¥¼ ê°€ì§‘ë‹ˆë‹¤. |
| `super.canActivate()` | ìƒìœ„ í´ë˜ìŠ¤(`AuthGuard`)ì˜ ë¡œì§ì„ ì‹¤í–‰í•˜ì—¬ Passport Strategy(JWT ê²€ì¦)ë¥¼ ì‘ë™ì‹œí‚µë‹ˆë‹¤. |
| `handleRequest` | ì¸ì¦ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì²˜ë¦¬ë¥¼ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•©ë‹ˆë‹¤. |


### ê¸€ë¡œë²Œ Guard ë“±ë¡

```typescript
// main.ts or app.module.ts
import { APP_GUARD } from '@nestjs/core';
import { JwtAuthGuard } from './auth/guards/jwt-auth.guard';

@Module({
  providers: [
    {
      provide: APP_GUARD,
      useClass: JwtAuthGuard,  // ëª¨ë“  ë¼ìš°íŠ¸ì— ì¸ì¦ ì ìš©
    },
  ],
})
export class AppModule {}
```

---

## ì»¤ìŠ¤í…€ ë°ì½”ë ˆì´í„°

### @Public() - ê³µê°œ ë¼ìš°íŠ¸

```typescript
// auth/decorators/public.decorator.ts
import { SetMetadata } from '@nestjs/common';

export const IS_PUBLIC_KEY = 'isPublic';
export const Public = () => SetMetadata(IS_PUBLIC_KEY, true);

// ì‚¬ìš©
@Controller('health')
export class HealthController {
  @Get()
  @Public()  // ì¸ì¦ ì—†ì´ ì ‘ê·¼ ê°€ëŠ¥
  check() {
    return { status: 'ok' };
  }
}
```

### @CurrentUser() - í˜„ì¬ ì‚¬ìš©ì

```typescript
// auth/decorators/current-user.decorator.ts
import { createParamDecorator, ExecutionContext } from '@nestjs/common';

export const CurrentUser = createParamDecorator(
  (data: unknown, ctx: ExecutionContext) => {
    const request = ctx.switchToHttp().getRequest();
    return request.user;  // Strategyì˜ validate()ì—ì„œ ë°˜í™˜í•œ ê°ì²´
  },
);

// ì‚¬ìš©
@Get('me')
getProfile(@CurrentUser() user: { id: string; email: string }) {
  return this.usersService.findOne(user.id);
}
```

### ğŸ” ì½”ë“œ ë¶„ì„
| ì½”ë“œ | ì„¤ëª… |
|------|------|
| `SetMetadata` | íŠ¹ì • í‚¤(`IS_PUBLIC_KEY`)ì™€ ê°’(`true`)ì„ ë©”íƒ€ë°ì´í„°ë¡œ ì €ì¥í•©ë‹ˆë‹¤. Guardì—ì„œ ì´ ê°’ì„ ì½ì–´ ì¸ì¦ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤. |
| `createParamDecorator` | ì»¤ìŠ¤í…€ íŒŒë¼ë¯¸í„° ë°ì½”ë ˆì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. |
| `ctx.switchToHttp().getRequest()` | ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ì—ì„œ HTTP ìš”ì²­ ê°ì²´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. |
| `request.user` | Passport Strategyì˜ `validate()` ë©”ì„œë“œê°€ ë°˜í™˜í•œ ì‚¬ìš©ì ì •ë³´ì…ë‹ˆë‹¤. |


---

## ì—­í•  ê¸°ë°˜ ì¸ê°€ (RBAC)

### Roles Guard

```typescript
// auth/guards/roles.guard.ts
import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { ROLES_KEY } from '../decorators/roles.decorator';

@Injectable()
export class RolesGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    // @Roles() ë°ì½”ë ˆì´í„°ì—ì„œ í•„ìš”í•œ ì—­í•  ê°€ì ¸ì˜¤ê¸°
    const requiredRoles = this.reflector.getAllAndOverride<string[]>(ROLES_KEY, [
      context.getHandler(),
      context.getClass(),
    ]);
    
    if (!requiredRoles) {
      return true;  // ì—­í•  ì œí•œ ì—†ìŒ
    }
    
    const { user } = context.switchToHttp().getRequest();
    return requiredRoles.includes(user.role);
  }
}
```

### ğŸ” ì½”ë“œ ë¶„ì„
| ì½”ë“œ | ì„¤ëª… |
|------|------|
| `requiredRoles` | `@Roles()` ë°ì½”ë ˆì´í„°ë¡œ ì„¤ì •ëœ í—ˆìš© ì—­í•  ëª©ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. |
| `if (!requiredRoles)` | ì—­í•  ì œí•œì´ ì—†ìœ¼ë©´ ëˆ„êµ¬ë‚˜ ì ‘ê·¼ ê°€ëŠ¥í•˜ë¯€ë¡œ `true`ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. |
| `request.user.role` | JWT í† í°(payload)ì— í¬í•¨ëœ ì‚¬ìš©ì ì—­í•  ì •ë³´ì…ë‹ˆë‹¤. |
| `includes()` | ì‚¬ìš©ìì˜ ì—­í• ì´ í—ˆìš©ëœ ì—­í•  ëª©ë¡ì— í¬í•¨ë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. |


### @Roles() ë°ì½”ë ˆì´í„°

```typescript
// auth/decorators/roles.decorator.ts
import { SetMetadata } from '@nestjs/common';

export const ROLES_KEY = 'roles';
export const Roles = (...roles: string[]) => SetMetadata(ROLES_KEY, roles);

// ì‚¬ìš©
@Delete(':id')
@Roles('admin')  // adminë§Œ ì‚­ì œ ê°€ëŠ¥
remove(@Param('id') id: string) {
  return this.usersService.remove(id);
}
```

### ê¸€ë¡œë²Œ ë“±ë¡

```typescript
@Module({
  providers: [
    { provide: APP_GUARD, useClass: JwtAuthGuard },   // 1. ì¸ì¦
    { provide: APP_GUARD, useClass: RolesGuard },     // 2. ì¸ê°€
  ],
})
export class AppModule {}
```

---

## ì‹¤ì „ ì˜ˆì œ: ì»¨íŠ¸ë¡¤ëŸ¬

```typescript
@Controller('users')
export class UsersController {
  constructor(private readonly usersService: UsersService) {}

  @Public()
  @Post('signup')
  signup(@Body() dto: CreateUserDto) {
    return this.usersService.create(dto);
  }

  @Get('me')
  getMe(@CurrentUser() user: { id: string }) {
    return this.usersService.findOne(user.id);
  }

  @Get()
  @Roles('admin')  // ê´€ë¦¬ìë§Œ
  findAll() {
    return this.usersService.findAll();
  }

  @Delete(':id')
  @Roles('admin')  // ê´€ë¦¬ìë§Œ
  remove(@Param('id') id: string) {
    return this.usersService.remove(id);
  }
}
```

---

---

## ğŸ’¡ ì‹¤ë¬´ íŒ

### 3. Request ê°ì²´ íƒ€ì… í™•ì¥
`req.user`ë¥¼ ì‚¬ìš©í•  ë•Œë§ˆë‹¤ `any` íƒ€ì…ì„ ì“°ì§€ ì•Šë„ë¡, Expressì˜ Request ì¸í„°í˜ì´ìŠ¤ë¥¼ í™•ì¥í•˜ì„¸ìš”.

```typescript
// types/express.d.ts
declare namespace Express {
  export interface Request {
    user?: User; // ìš°ë¦¬ê°€ ì •ì˜í•œ User íƒ€ì…
  }
}
```
ì´ì œ `req.user.id` ì²˜ëŸ¼ ìë™ ì™„ì„±ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 1. ì¸ì¦ ì—ëŸ¬ ì‘ë‹µ ì¼ê´€ì„±

```typescript
handleRequest(err: any, user: any, info: any) {
  if (info?.name === 'TokenExpiredError') {
    throw new UnauthorizedException({
      code: 'TOKEN_EXPIRED',
      message: 'í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
    });
  }
  if (err || !user) {
    throw new UnauthorizedException({
      code: 'INVALID_TOKEN',
      message: 'ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤',
    });
  }
  return user;
}
```

### 2. ì„ íƒì  ì¸ì¦

```typescript
// ì¸ì¦ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ null
@Injectable()
export class OptionalJwtAuthGuard extends AuthGuard('supabase-jwt') {
  handleRequest(err: any, user: any) {
    return user || null;  // ì—ëŸ¬ ì—†ì´ null ë°˜í™˜
  }
}

// ì‚¬ìš©
@UseGuards(OptionalJwtAuthGuard)
@Get('posts')
findAll(@CurrentUser() user: User | null) {
  // userê°€ ìˆìœ¼ë©´ ê°œì¸í™”ëœ ëª©ë¡
  // ì—†ìœ¼ë©´ ê³µê°œ ëª©ë¡
}
```

---

## ë ˆí¼ëŸ°ìŠ¤

- [NestJS - Authentication](https://docs.nestjs.com/security/authentication)
- [NestJS - Authorization](https://docs.nestjs.com/security/authorization)
- [Supabase - Auth](https://supabase.com/docs/guides/auth)
- [passport-jwt](https://github.com/mikenicholson/passport-jwt)

**ë‹¤ìŒ ì¥**: [07. ì—ëŸ¬ ì²˜ë¦¬](./07-error-handling.md)
