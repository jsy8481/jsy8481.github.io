---
title: "01. TanStack Query ê¸°ì´ˆ"
description: "TanStack QueryëŠ” ì„œë²„ ìƒíƒœ ê´€ë¦¬ë¥¼ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤. API ë°ì´í„° í˜ì¹­, ìºì‹±, ë™ê¸°í™”, ì—…ë°ì´íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì¤ë‹ˆë‹¤."
date: "2026-02-16"
---

## TanStack Queryë€?

### ê°œë… ì •ì˜

**TanStack Query** (êµ¬ React Query)ëŠ” ì„œë²„ ìƒíƒœ ê´€ë¦¬ë¥¼ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤. API ë°ì´í„° í˜ì¹­, ìºì‹±, ë™ê¸°í™”, ì—…ë°ì´íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì¤ë‹ˆë‹¤.

> ğŸ’¡ **í•µì‹¬ í†µì°°**: ì„œë²„ ë°ì´í„°ëŠ” "ê°€ì ¸ì˜¤ê¸°"ë§Œ í•˜ëŠ” ê²Œ ì•„ë‹™ë‹ˆë‹¤. ìºì‹±í•˜ê³ , ì˜¤ë˜ë˜ë©´ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê³ , ì—ëŸ¬ê°€ ë‚˜ë©´ ì¬ì‹œë„í•˜ê³ , ë°±ê·¸ë¼ìš´ë“œì—ì„œ ê°±ì‹ í•˜ëŠ” ë“± ë³µì¡í•œ ìƒëª…ì£¼ê¸°ê°€ ìˆìŠµë‹ˆë‹¤. TanStack QueryëŠ” ì´ ëª¨ë“  ê²ƒì„ ì¶”ìƒí™”í•©ë‹ˆë‹¤.

### ì™œ TanStack Queryê°€ í•„ìš”í•œê°€?

**ë¬¸ì œì : ì§ì ‘ êµ¬í˜„í•˜ë©´ ë°œìƒí•˜ëŠ” ë³µì¡ì„±**

```tsx
// âŒ ì§ì ‘ êµ¬í˜„: ì ì  ë³µì¡í•´ì§€ëŠ” ì½”ë“œ
function UserList() {
  const [users, setUsers] = useState<User[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);

  useEffect(() => {
    let cancelled = false;  // cleanupì„ ìœ„í•œ í”Œë˜ê·¸
    
    async function fetchUsers() {
      try {
        setIsLoading(true);
        setError(null);
        
        const response = await fetch('/api/users');
        if (!response.ok) throw new Error('Failed to fetch');
        
        const data = await response.json();
        if (!cancelled) setUsers(data);
        
      } catch (err) {
        if (!cancelled) setError(err as Error);
      } finally {
        if (!cancelled) setIsLoading(false);
      }
    }
    
    fetchUsers();
    
    return () => { cancelled = true; };  // cleanup
  }, []);

  // ìºì‹±ì€? ì¬ì‹œë„ëŠ”? ë°±ê·¸ë¼ìš´ë“œ ê°±ì‹ ì€? 
  // ê°™ì€ ë°ì´í„°ë¥¼ ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ì—ì„œë„ ì“°ë©´?
  // ... ê³„ì† ë” ë³µì¡í•´ì§
}
```

**í•´ê²°ì±…: TanStack Query ì‚¬ìš©**

```tsx
// âœ… TanStack Query: ê°„ê²°í•˜ê³  ì™„ì „í•œ ê¸°ëŠ¥
function UserList() {
  const { data: users, isLoading, error, refetch } = useQuery({
    queryKey: ['users'],
    queryFn: () => fetch('/api/users').then(r => r.json()),
  });

  if (isLoading) return <div>ë¡œë”© ì¤‘...</div>;
  if (error) return <div>ì—ëŸ¬: {error.message}</div>;
  
  return (
    <ul>
      {users.map(user => <li key={user.id}>{user.name}</li>)}
    </ul>
  );
}
```

---

## ì„¤ì • (Query Client)

### Query Clientë€?

**QueryClient** ëŠ” ì¿¼ë¦¬ ìºì‹œë¥¼ ê´€ë¦¬í•˜ëŠ” í•µì‹¬ ê°ì²´ì…ë‹ˆë‹¤. ì•± ì „ì²´ì—ì„œ í•˜ë‚˜ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê³µìœ í•©ë‹ˆë‹¤.

### Next.jsì—ì„œ ì„¤ì •

```tsx
// app/providers.tsx
'use client';

import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { useState } from 'react';

export function Providers({ children }: { children: React.ReactNode }) {
  // useStateë¡œ ìƒì„±: ì»´í¬ë„ŒíŠ¸ ê°„ ì¸ìŠ¤í„´ìŠ¤ ê³µìœ  + SSR ì•ˆì „
  const [queryClient] = useState(() => new QueryClient({
    defaultOptions: {
      queries: {
        // ë°ì´í„°ê°€ "ì‹ ì„ "í•œ ì‹œê°„: ì´ ë™ì•ˆì€ ì¬ìš”ì²­ ì•ˆ í•¨
        staleTime: 60 * 1000,  // 1ë¶„
        
        // ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ íšŸìˆ˜
        retry: 1,
        
        // ë¸Œë¼ìš°ì € íƒ­ì´ í¬ì»¤ìŠ¤ë  ë•Œ ìë™ ì¬ìš”ì²­ (ëŒ ìˆ˜ë„ ìˆìŒ)
        refetchOnWindowFocus: true,
      },
    },
  }));

  return (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  );
}
```

**ì½”ë“œ ì„¤ëª…:**
- `useState(() => new QueryClient())`: ì»´í¬ë„ŒíŠ¸ê°€ ë¦¬ë Œë”ë§ë˜ì–´ë„ ê°™ì€ ì¸ìŠ¤í„´ìŠ¤ ìœ ì§€
- `staleTime: 60 * 1000`: ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ í›„ 1ë¶„ ë™ì•ˆì€ "ì‹ ì„ "í•˜ë‹¤ê³  ê°„ì£¼, ì¬ìš”ì²­ ì•ˆ í•¨
- `retry: 1`: ìš”ì²­ ì‹¤íŒ¨ ì‹œ 1ë²ˆ ë” ì‹œë„ í›„ í¬ê¸°
- `QueryClientProvider`: í•˜ìœ„ ì»´í¬ë„ŒíŠ¸ì—ì„œ `useQuery` ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ í•¨

```tsx
// app/layout.tsx
import { Providers } from './providers';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="ko">
      <body>
        <Providers>{children}</Providers>
      </body>
    </html>
  );
}
```

---

## useQuery ê¸°ë³¸ ì‚¬ìš©ë²•

### ê¸°ë³¸ êµ¬ì¡°

```tsx
import { useQuery } from '@tanstack/react-query';

function UserProfile({ userId }: { userId: string }) {
  const {
    data,        // ì„±ê³µ ì‹œ ë°˜í™˜ëœ ë°ì´í„°
    isLoading,   // ìµœì´ˆ ë¡œë”© ì¤‘
    isFetching,  // ë°±ê·¸ë¼ìš´ë“œ ê°±ì‹  ì¤‘ (isLoading í¬í•¨)
    isError,     // ì—ëŸ¬ ë°œìƒ ì—¬ë¶€
    error,       // ì—ëŸ¬ ê°ì²´
    refetch,     // ìˆ˜ë™ìœ¼ë¡œ ë‹¤ì‹œ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜
  } = useQuery({
    queryKey: ['user', userId],  // ì¿¼ë¦¬ ì‹ë³„ì
    queryFn: () => getUser(userId),  // ì‹¤ì œ ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
  });

  // ... ìƒíƒœì— ë”°ë¥¸ UI ë Œë”ë§
}
```

**ë°˜í™˜ ê°ì²´ ìƒì„¸ ì„¤ëª…:**
- `data`: ì¿¼ë¦¬ê°€ ì„±ê³µí•˜ë©´ ì—¬ê¸°ì— ê²°ê³¼ê°€ ë‹´ê¹ë‹ˆë‹¤. ë¡œë”© ì¤‘ì´ê±°ë‚˜ ì—ëŸ¬ë©´ `undefined`
- `isLoading`: **ì²˜ìŒ** ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ë•Œë§Œ `true`. ìºì‹œê°€ ìˆìœ¼ë©´ `false`
- `isFetching`: ë°±ê·¸ë¼ìš´ë“œì—ì„œ ê°±ì‹  ì¤‘ì¼ ë•Œë„ `true`. `isLoading`ë³´ë‹¤ ë„“ì€ ê°œë…
- `error`: TypeScriptì—ì„œ ì‚¬ìš© ì‹œ íƒ€ì… ì§€ì • í•„ìš” (`error as Error`)
- `refetch()`: ì´ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´ ì¿¼ë¦¬ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë‹¤ì‹œ ì‹¤í–‰

### ìƒíƒœë³„ UI ì²˜ë¦¬ íŒ¨í„´

```tsx
function UserProfile({ userId }: { userId: string }) {
  const { data, isLoading, isError, error, isFetching } = useQuery({
    queryKey: ['user', userId],
    queryFn: () => getUser(userId),
  });

  // 1. ìµœì´ˆ ë¡œë”© ìƒíƒœ
  if (isLoading) {
    return <Skeleton />;  // ë¡œë”© ìŠ¤ì¼ˆë ˆí†¤ í‘œì‹œ
  }

  // 2. ì—ëŸ¬ ìƒíƒœ
  if (isError) {
    return (
      <div className="error">
        <p>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {(error as Error).message}</p>
        <button onClick={() => refetch()}>ë‹¤ì‹œ ì‹œë„</button>
      </div>
    );
  }

  // 3. ì„±ê³µ ìƒíƒœ (dataê°€ í™•ì‹¤íˆ ì¡´ì¬)
  return (
    <div>
      <h1>{data.name}</h1>
      <p>{data.email}</p>
      {/* ë°±ê·¸ë¼ìš´ë“œ ê°±ì‹  ì¤‘ì´ë©´ ì‘ì€ ì¸ë””ì¼€ì´í„° í‘œì‹œ */}
      {isFetching && <span className="updating">ì—…ë°ì´íŠ¸ ì¤‘...</span>}
    </div>
  );
}
```

---

## Query Key (ì¿¼ë¦¬ í‚¤)

### ê°œë…

**Query Key** ëŠ” ì¿¼ë¦¬ë¥¼ ê³ ìœ í•˜ê²Œ ì‹ë³„í•˜ëŠ” ë°°ì—´ì…ë‹ˆë‹¤. ìºì‹œ ì €ì¥/ì¡°íšŒ, ì¿¼ë¦¬ ë¬´íš¨í™” ë“±ì— ì‚¬ìš©ë©ë‹ˆë‹¤.

### ì™œ ë°°ì—´ì¸ê°€?

```tsx
// ë‹¨ìˆœí•œ ë¬¸ìì—´ ëŒ€ì‹  ë°°ì—´ì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ :
// ê³„ì¸µì ì¸ í‚¤ êµ¬ì¡°ë¡œ ê´€ë ¨ ì¿¼ë¦¬ë¥¼ ê·¸ë£¹í™”í•  ìˆ˜ ìˆìŒ

// ì˜ˆì‹œ: ì‚¬ìš©ì ê´€ë ¨ ì¿¼ë¦¬ë“¤
['users']                        // ëª¨ë“  ì‚¬ìš©ì ëª©ë¡
['users', 'list']                // ì‚¬ìš©ì ëª©ë¡ (ëª…í™•í•œ êµ¬ë¶„)
['users', 'detail', 'user-123']  // íŠ¹ì • ì‚¬ìš©ì ìƒì„¸
['users', 'posts', 'user-123']   // íŠ¹ì • ì‚¬ìš©ìì˜ ê²Œì‹œê¸€

// ìºì‹œ ë¬´íš¨í™” ì‹œ ê³„ì¸µ í™œìš©
queryClient.invalidateQueries({ queryKey: ['users'] });
// ìœ„ í•œ ì¤„ë¡œ 'users'ë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  ì¿¼ë¦¬ ë¬´íš¨í™”!
```

### Query Key ì„¤ê³„ íŒ¨í„´

```tsx
// ì—”í‹°í‹° íƒ€ì… â†’ ì„¸ë¶€ êµ¬ë¶„ â†’ ID/í•„í„° ìˆœì„œë¡œ êµ¬ì„±
const queryKeys = {
  // ì£¼ì‹ ê´€ë ¨
  stocks: {
    all: ['stocks'] as const,
    lists: () => [...queryKeys.stocks.all, 'list'] as const,
    list: (filters: StockFilters) => 
      [...queryKeys.stocks.lists(), filters] as const,
    details: () => [...queryKeys.stocks.all, 'detail'] as const,
    detail: (symbol: string) => 
      [...queryKeys.stocks.details(), symbol] as const,
  },
  
  // ì‚¬ìš©ì ê´€ë ¨
  users: {
    all: ['users'] as const,
    detail: (id: string) => ['users', 'detail', id] as const,
  },
};

// ì‚¬ìš©
useQuery({
  queryKey: queryKeys.stocks.detail('AAPL'),
  queryFn: () => getStockDetail('AAPL'),
});
```

**`as const` ì‚¬ìš© ì´ìœ :**
- TypeScriptì—ì„œ íŠœí”Œ íƒ€ì…ìœ¼ë¡œ ì¶”ë¡ ë˜ì–´ íƒ€ì… ì•ˆì „ì„± í–¥ìƒ
- ë°°ì—´ì´ ë¶ˆë³€(immutable)ì„ì„ ëª…ì‹œ

---

## API í•¨ìˆ˜ ë¶„ë¦¬

### ì™œ ë¶„ë¦¬í•˜ë‚˜ìš”?

```tsx
// âŒ ë‚˜ìœ ì˜ˆ: ì»´í¬ë„ŒíŠ¸ì— ì§ì ‘ ì‘ì„±
useQuery({
  queryKey: ['stocks', symbol],
  queryFn: async () => {
    const res = await fetch(`${API_URL}/stocks/${symbol}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) throw new Error('Failed');
    return res.json();
  },
});
// ë¬¸ì œ: ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ ê°™ì€ API í˜¸ì¶œ ì‹œ ì¤‘ë³µ

// âœ… ì¢‹ì€ ì˜ˆ: API í•¨ìˆ˜ ë¶„ë¦¬
// lib/api/stocks.ts
export async function getStock(symbol: string): Promise<Stock> {
  const res = await fetch(`${API_URL}/stocks/${symbol}`);
  if (!res.ok) throw new Error('Failed to fetch stock');
  return res.json();
}

// ì»´í¬ë„ŒíŠ¸ì—ì„œ
useQuery({
  queryKey: ['stocks', symbol],
  queryFn: () => getStock(symbol),
});
```

### API ëª¨ë“ˆ êµ¬ì„± ì˜ˆì‹œ

```typescript
// lib/api/index.ts
const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001';

// ê³µí†µ fetch ë˜í¼ (ì—ëŸ¬ ì²˜ë¦¬, í—¤ë” ë“±)
async function fetchAPI<T>(endpoint: string, options?: RequestInit): Promise<T> {
  const res = await fetch(`${API_URL}${endpoint}`, {
    headers: {
      'Content-Type': 'application/json',
      ...options?.headers,
    },
    ...options,
  });
  
  if (!res.ok) {
    const error = await res.json().catch(() => ({}));
    throw new Error(error.message || 'API Error');
  }
  
  return res.json();
}
```

```typescript
// lib/api/stocks.ts
import { Stock, StockDetail } from '@repo/schema';

export const stocksApi = {
  // ëª©ë¡ ì¡°íšŒ
  getAll: (filters?: { exchange?: string }) => 
    fetchAPI<Stock[]>(`/stocks?${new URLSearchParams(filters)}`),
  
  // ìƒì„¸ ì¡°íšŒ
  getBySymbol: (symbol: string) => 
    fetchAPI<StockDetail>(`/stocks/${symbol}`),
  
  // ìƒì„±
  create: (data: CreateStockInput) =>
    fetchAPI<Stock>('/stocks', {
      method: 'POST',
      body: JSON.stringify(data),
    }),
};
```

```tsx
// ì»´í¬ë„ŒíŠ¸ì—ì„œ ê¹”ë”í•˜ê²Œ ì‚¬ìš©
import { stocksApi } from '@/lib/api/stocks';

function StockList() {
  const { data } = useQuery({
    queryKey: queryKeys.stocks.all,
    queryFn: stocksApi.getAll,
  });
}
```

---

## ì¡°ê±´ë¶€ ì¿¼ë¦¬ (enabled ì˜µì…˜)

### ì–¸ì œ ì‚¬ìš©í•˜ë‚˜ìš”?

íŠ¹ì • ì¡°ê±´ì´ ì¶©ì¡±ë  ë•Œë§Œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•´ì•¼ í•˜ëŠ” ê²½ìš°:

```tsx
function StockDetail({ symbol }: { symbol: string | null }) {
  const { data, isLoading } = useQuery({
    queryKey: ['stock', symbol],
    queryFn: () => getStock(symbol!),
    enabled: !!symbol,  // symbolì´ ìˆì„ ë•Œë§Œ ì¿¼ë¦¬ ì‹¤í–‰
  });

  // symbolì´ nullì´ë©´:
  // - isLoading: false
  // - data: undefined
  // - ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ì•ˆ í•¨
  
  if (!symbol) return <p>ì£¼ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>;
  if (isLoading) return <p>ë¡œë”© ì¤‘...</p>;
  
  return <div>{data?.name}</div>;
}
```

**`enabled: false`ì¼ ë•Œ:**
- ì¿¼ë¦¬ê°€ **ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ**
- `isLoading`ì€ `false` (ì²˜ìŒë¶€í„° ë¡œë”© ìƒíƒœ ì•„ë‹˜)
- `status`ëŠ” `'pending'` (ì•„ì§ ì‹œì‘ ì•ˆ í•¨)
- `refetch()`ë¥¼ ìˆ˜ë™ìœ¼ë¡œ í˜¸ì¶œí•˜ë©´ ì‹¤í–‰ë¨

### ì¢…ì† ì¿¼ë¦¬ (Dependent Queries)

ì²« ë²ˆì§¸ ì¿¼ë¦¬ ê²°ê³¼ë¥¼ ë‘ ë²ˆì§¸ ì¿¼ë¦¬ì—ì„œ ì‚¬ìš©:

```tsx
function UserPosts({ userId }: { userId: string }) {
  // 1. ë¨¼ì € ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
  const { data: user } = useQuery({
    queryKey: ['user', userId],
    queryFn: () => getUser(userId),
  });

  // 2. ì‚¬ìš©ì ì •ë³´ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì‚¬ìš©ìì˜ ê²Œì‹œê¸€ ì¡°íšŒ
  const { data: posts } = useQuery({
    queryKey: ['posts', user?.id],
    queryFn: () => getPostsByUserId(user!.id),
    enabled: !!user,  // userê°€ ë¡œë“œëœ í›„ì—ë§Œ ì‹¤í–‰
  });
}
```

---

## í™œìš© íŒ

### 1. DevTools ì‚¬ìš©

```tsx
// ê°œë°œ í™˜ê²½ì—ì„œ ì¿¼ë¦¬ ìƒíƒœ í™•ì¸
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';

function Providers({ children }) {
  return (
    <QueryClientProvider client={queryClient}>
      {children}
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  );
}
```

**DevToolsë¡œ í™•ì¸í•  ìˆ˜ ìˆëŠ” ê²ƒ:**
- ëª¨ë“  ì¿¼ë¦¬ì˜ ìƒíƒœ (fresh, stale, fetching ë“±)
- ìºì‹œëœ ë°ì´í„° ë‚´ìš©
- ê° ì¿¼ë¦¬ì˜ ì„¤ì •ê°’

### 2. ì—ëŸ¬ ë°”ìš´ë”ë¦¬ì™€ í•¨ê»˜ ì‚¬ìš©

```tsx
import { QueryErrorResetBoundary } from '@tanstack/react-query';
import { ErrorBoundary } from 'react-error-boundary';

function App() {
  return (
    <QueryErrorResetBoundary>
      {({ reset }) => (
        <ErrorBoundary
          onReset={reset}
          fallbackRender={({ error, resetErrorBoundary }) => (
            <div>
              <p>ì—ëŸ¬: {error.message}</p>
              <button onClick={resetErrorBoundary}>ë‹¤ì‹œ ì‹œë„</button>
            </div>
          )}
        >
          <UserProfile />
        </ErrorBoundary>
      )}
    </QueryErrorResetBoundary>
  );
}
```

---

## ë ˆí¼ëŸ°ìŠ¤

- [TanStack Query - Quick Start](https://tanstack.com/query/latest/docs/framework/react/quick-start)
- [TanStack Query - Query Keys](https://tanstack.com/query/latest/docs/framework/react/guides/query-keys)
- [TanStack Query - Dependent Queries](https://tanstack.com/query/latest/docs/framework/react/guides/dependent-queries)

**ë‹¤ìŒ ì¥**: [05. ë®¤í…Œì´ì…˜](./05-tanstack-mutations.md)
