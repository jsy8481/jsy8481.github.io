---
title: "09. Supabase ì—°ë™ (Supabase Integration)"
description: "Supabaseì™€ Drizzle ORMì„ ì—°ë™í•˜ì—¬ Auth, RLS, Edge Functions ë“± ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ í™œìš©í•˜ëŠ” ë°©ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤."
date: "2026-02-16"
---

SupabaseëŠ” ë‹¨ìˆœí•œ DBê°€ ì•„ë‹ˆë¼ **Backend-as-a-Service**ì…ë‹ˆë‹¤. Drizzleì„ Supabaseì˜ ë‹¤ì–‘í•œ ê¸°ëŠ¥(Auth, RLS, Edge Functions)ê³¼ í•¨ê»˜ 200% í™œìš©í•˜ëŠ” ë°©ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤.

---

## ğŸ”Œ 1. ì—°ê²° ì„¤ì •: Transaction(6543) vs Session(5432)

Supabase ëŒ€ì‹œë³´ë“œ > Settings > Database > Connection pooling ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.

| ëª¨ë“œ | í¬íŠ¸ | ìš©ë„ | ë¹„ê³  |
|------|------|------|------|
| **Session Mode** | `5432` | **Migration** | `drizzle-kit`ì€ ì§ì ‘ ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤. |
| **Transaction Mode** | `6543` | **Application** | `NestJS`, `Next.js` ë“± ì•± ì‹¤í–‰ ì‹œ. (Supavisor ì‚¬ìš©) |

### ğŸš¨ ì£¼ì˜: `prepare: false`
Transaction Mode(6543)ëŠ” ì¿¼ë¦¬ë¥¼ ë¯¸ë¦¬ ì¤€ë¹„í•˜ëŠ” `Prepared Statement` ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Supavisor ì œí•œì‚¬í•­). ë”°ë¼ì„œ Drizzle ì„¤ì •ì—ì„œ ë°˜ë“œì‹œ êº¼ì•¼ í•©ë‹ˆë‹¤.

```typescript
// src/db/index.ts
import postgres from 'postgres';
import { drizzle } from 'drizzle-orm/postgres-js';

const connectionString = process.env.DATABASE_URL!; // 6543 í¬íŠ¸ ì£¼ì†Œ
const client = postgres(connectionString, { 
  prepare: false // ğŸ‘ˆ ì´ê±° ì•ˆ í•˜ë©´ "prepared statement already exists" ì—ëŸ¬ í„°ì§
});

export const db = drizzle(client);
```

---

## ğŸ” 2. RLS (Row Level Security)ì™€ Drizzle

Supabaseì˜ ê°•ë ¥í•œ ë³´ì•ˆ ê¸°ëŠ¥ì¸ RLSëŠ” **"ëˆ„ê°€ ìš”ì²­í–ˆëŠëƒ"** ì— ë”°ë¼ ë°ì´í„°ë¥¼ ë³´ì—¬ì£¼ê±°ë‚˜ ìˆ¨ê¹ë‹ˆë‹¤.

### Drizzleì€ ë³´í†µ "Admin"ì´ë‹¤
`NestJS`ë‚˜ `Next.js API Route`ì—ì„œ ì‹¤í–‰ë˜ëŠ” Drizzleì€ ë³´í†µ **Service Role Key** (ê´€ë¦¬ì í‚¤)ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, DB ì ‘ì† ì •ë³´ë¥¼ ì§ì ‘ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš° **RLSë¥¼ ìš°íšŒ(Bypass)** í•©ë‹ˆë‹¤. (ìŠˆí¼ ìœ ì € ê¶Œí•œ)

**ë”°ë¼ì„œ ë°±ì—”ë“œ ì½”ë“œì—ì„œ ì§ì ‘ ê¶Œí•œ ê²€ì‚¬ë¥¼ í•´ì•¼ í•©ë‹ˆë‹¤.**

```typescript
// users.service.ts
async findMyPosts(userId: number) {
  return db.query.posts.findMany({
    // RLSê°€ ìë™ìœ¼ë¡œ ì•ˆ ë§‰ì•„ì£¼ë¯€ë¡œ, whereì ˆë¡œ ì§ì ‘ í•„í„°ë§ í•„ìˆ˜
    where: (posts, { eq }) => eq(posts.authorId, userId),
  });
}
```

### RLSë¥¼ ì ìš©í•˜ê³  ì‹¶ë‹¤ë©´? (Advanced)
Drizzle ì¿¼ë¦¬ ì‹¤í–‰ ì „ì— í˜„ì¬ ìœ ì € ì„¸ì…˜ì„ DBì— ì„¤ì •í•´ì£¼ëŠ” ë°©ì‹ì„ ì”ë‹ˆë‹¤. (Postgres ì„¸ì…˜ ë³€ìˆ˜ í™œìš©)

```typescript
await db.transaction(async (tx) => {
  // 1. í˜„ì¬ íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ìœ ì € ID ì„¤ì • (Supabaseê°€ ì¸ì‹í•˜ë„ë¡)
  await tx.execute(sql`set local request.jwt.claim.sub = ${userId}`);
  
  // 2. ì´ì œ ì¿¼ë¦¬í•˜ë©´ RLSê°€ ì‘ë™í•¨
  return tx.query.posts.findMany(); 
});
```

---

## ğŸŒ 3. Edge Functions (Deno ê¸°ë°˜)

Supabase Edge Functionsì—ì„œ Drizzleì„ ì“¸ ë• `postgres.js` ëŒ€ì‹  ê°€ë²¼ìš´ ë“œë¼ì´ë²„ë‚˜ HTTP ì—°ê²°ì„ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤.

```typescript
// deno.json
{
  "imports": {
    "drizzle-orm": "npm:drizzle-orm@...",
    "postgres": "npm:postgres@..."
  }
}
```
Deno í™˜ê²½ì—ì„œë„ `npm:` ì ‘ë‘ì–´ë¥¼ í†µí•´ ë˜‘ê°™ì´ Drizzleì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¨, **ì—°ê²° ìˆ˜ ê´€ë¦¬** ë¥¼ ìœ„í•´ Transaction Mode(Pooling) ì‚¬ìš©ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.

---

## ğŸš€ 4. ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

1.  [ ] `DATABASE_URL`ì´ 6543(Transaction) í¬íŠ¸ì¸ê°€?
2.  [ ] `DIRECT_URL`ì´ 5432(Session) í¬íŠ¸ì¸ê°€?
3.  [ ] `drizzle.config.ts`ëŠ” `DIRECT_URL`ì„ ë°”ë¼ë³´ëŠ”ê°€?
4.  [ ] í”„ë¡œë•ì…˜ DB ë°±ì—…ì€ ì„¤ì •ë˜ì—ˆëŠ”ê°€? (Supabase Pro í”Œëœ ì´ìƒ ê¶Œì¥)

---

## ğŸ”— ë ˆí¼ëŸ°ìŠ¤
- [Supabase Connection Pooling](https://supabase.com/docs/guides/database/connecting/connection-pooling)
- [Drizzle with Supabase](https://orm.drizzle.team/learn/tutorials/drizzle-with-supabase)
