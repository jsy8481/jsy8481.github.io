---
title: "05. Drizzle ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™"
description: "NestJSì˜ ëª¨ë“ˆ ì‹œìŠ¤í…œê³¼ ì˜ì¡´ì„± ì£¼ì…ì„ í™œìš©í•˜ì—¬ Drizzle ORMì„ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤."
date: "2026-02-16"
---

## NestJS + Drizzle í†µí•©

### ì™œ ì´ ì¡°í•©ì¸ê°€?

NestJSì˜ **ëª¨ë“ˆ ì‹œìŠ¤í…œ**ê³¼ ** ì˜ì¡´ì„± ì£¼ì…**ì„ í™œìš©í•˜ì—¬ Drizzle ORMì„ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NestJS ëª¨ë“ˆ ì‹œìŠ¤í…œ       â”‚  Drizzle ORM                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ ì˜ì¡´ì„± ì£¼ì… (DI)       â”‚  â€¢ íƒ€ì… ì•ˆì „ ì¿¼ë¦¬                   â”‚
â”‚  â€¢ ëª¨ë“ˆ ìº¡ìŠí™”            â”‚  â€¢ ìŠ¤í‚¤ë§ˆ ì •ì˜                      â”‚
â”‚  â€¢ í…ŒìŠ¤íŠ¸ ìš©ì´ì„±          â”‚  â€¢ ë§ˆì´ê·¸ë ˆì´ì…˜                     â”‚
â”‚  â€¢ ë¼ì´í”„ì‚¬ì´í´ ê´€ë¦¬      â”‚  â€¢ ê´€ê³„í˜• ì¿¼ë¦¬ API                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## DatabaseModule ìƒì„±

### ê¸°ë³¸ êµ¬ì¡°

```typescript
// database/database.module.ts
import { Global, Module } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { drizzle, PostgresJsDatabase } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import * as schema from '@repo/schema';

// ì£¼ì… í† í° ìƒìˆ˜
export const DATABASE_TOKEN = 'DATABASE';

@Global()  // ì „ì—­ ëª¨ë“ˆ - ëª¨ë“  ê³³ì—ì„œ import ì—†ì´ ì‚¬ìš©
@Module({
  providers: [
    {
      provide: DATABASE_TOKEN,
      useFactory: (configService: ConfigService) => {
        const databaseUrl = configService.getOrThrow<string>('DATABASE_URL');
        
        const client = postgres(databaseUrl, {
          max: 10,         // ìµœëŒ€ ì—°ê²° ìˆ˜
          idle_timeout: 20, // ìœ íœ´ ì—°ê²° íƒ€ì„ì•„ì›ƒ
          prepare: false,  // Supabase Pooler ì‚¬ìš© ì‹œ í•„ìˆ˜ (ì„¸ì…˜ ëª¨ë“œ)
        });
        
        return drizzle(client, { schema });
      },
      inject: [ConfigService],  // ì˜ì¡´ì„± ì£¼ì… í‘œì‹œ
    },
  ],
  exports: [DATABASE_TOKEN],
})
export class DatabaseModule {}
```

### ğŸ” ì½”ë“œ ë¶„ì„
| ì½”ë“œ | ì„¤ëª… |
|------|------|
| `@Global()` | ì´ ëª¨ë“ˆì„ **ì „ì—­ ëª¨ë“ˆ** ë¡œ ë“±ë¡í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ëª¨ë“ˆì—ì„œ `imports` ë°°ì—´ì— ì¶”ê°€í•˜ì§€ ì•Šì•„ë„ ì œê³µí•˜ëŠ” Provider(`DATABASE_TOKEN`)ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. |
| `DATABASE_TOKEN` | DI ì»¨í…Œì´ë„ˆì—ì„œ Drizzle ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‹ë³„í•˜ê¸° ìœ„í•œ ê³ ìœ  ë¬¸ìì—´ í† í°ì…ë‹ˆë‹¤. |
| `useFactory` | ë¹„ë™ê¸° ì‘ì—…(ConfigService ì¡°íšŒ)ì´ë‚˜ ë³µì¡í•œ ì´ˆê¸°í™” ë¡œì§ì„ í†µí•´ Providerë¥¼ ìƒì„±í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤. |
| `postgres(...)` | `postgres` ë“œë¼ì´ë²„ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤ì œ DB ì—°ê²° í´ë¼ì´ì–¸íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (Connection Pool) |
| `drizzle(...)` | ìƒì„±ëœ í´ë¼ì´ì–¸íŠ¸ë¥¼ ê°ì‹¸ì„œ Drizzle ORM ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. `schema` ì˜µì…˜ì„ ì „ë‹¬í•´ì•¼ íƒ€ì… ì¶”ë¡ ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. |




### íƒ€ì… ì •ì˜

```typescript
// database/database.types.ts
import { PostgresJsDatabase } from 'drizzle-orm/postgres-js';
import * as schema from '@repo/schema';

// Drizzle ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…
export type Database = PostgresJsDatabase<typeof schema>;
```

---

## ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©

### ê¸°ë³¸ ì£¼ì… íŒ¨í„´

```typescript
// stocks/stocks.service.ts
import { Injectable, Inject } from '@nestjs/common';
import { DATABASE_TOKEN, Database } from '../database';
import { stocks, Stock, NewStock } from '@repo/schema';
import { eq, desc } from 'drizzle-orm';

@Injectable()
export class StocksService {
  constructor(
    @Inject(DATABASE_TOKEN) 
    private readonly db: Database,
  ) {}

  async findAll(): Promise<Stock[]> {
    return this.db.query.stocks.findMany({
      orderBy: [desc(stocks.marketCap)],
    });
  }

  async findBySymbol(symbol: string): Promise<Stock | undefined> {
    return this.db.query.stocks.findFirst({
      where: eq(stocks.symbol, symbol),
    });
  }

  async create(data: NewStock): Promise<Stock> {
    const [stock] = await this.db
      .insert(stocks)
      .values(data)
      .returning();
    return stock;
  }

  async update(symbol: string, data: Partial<NewStock>): Promise<Stock> {
    const [updated] = await this.db
      .update(stocks)
      .set({ ...data, updatedAt: new Date() })
      .where(eq(stocks.symbol, symbol))
      .returning();
    return updated;
  }

  async remove(symbol: string): Promise<void> {
    await this.db
      .delete(stocks)
      .where(eq(stocks.symbol, symbol));
  }
}
```

### ğŸ” ì½”ë“œ ë¶„ì„
| ì½”ë“œ | ì„¤ëª… |
|------|------|
| `@Inject(DATABASE_TOKEN)` | ì»¤ìŠ¤í…€ Providerì¸ DB ì—°ê²° ê°ì²´ë¥¼ ì£¼ì…ë°›ìŠµë‹ˆë‹¤. |
| `this.db.query.stocks.findMany` | Drizzleì˜ **Query API** ë¥¼ ì‚¬ìš©í•˜ì—¬ ê´€ê³„í˜• ë°ì´í„° ì¡°íšŒë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤. |
| `.insert(stocks).values(data)` | SQL `INSERT` ë¬¸ì„ ìƒì„±í•˜ê³  ì‹¤í–‰í•©ë‹ˆë‹¤. |
| `.returning()` | Postgresì˜ `RETURNING *` êµ¬ë¬¸ì„ ì‚¬ìš©í•˜ì—¬ ì‚½ì…/ìˆ˜ì •ëœ ë°ì´í„°ë¥¼ ì¦‰ì‹œ ë°˜í™˜ë°›ìŠµë‹ˆë‹¤. (ì¶”ê°€ ì¡°íšŒ ì¿¼ë¦¬ ë¶ˆí•„ìš”) |
| `.set({ ...data, updatedAt: ... })` | SQL `UPDATE` ë¬¸ì—ì„œ ë³€ê²½í•  ì»¬ëŸ¼ê³¼ ê°’ì„ ì§€ì •í•©ë‹ˆë‹¤. |
| `eq(stocks.symbol, symbol)` | `WHERE` ì ˆì—ì„œ ì‚¬ìš©í•  ë™ë“± ë¹„êµ ì¡°ê±´ì…ë‹ˆë‹¤. |


### ê´€ê³„ í¬í•¨ ì¿¼ë¦¬

```typescript
async findWithDetails(symbol: string) {
  return this.db.query.stocks.findFirst({
    where: eq(stocks.symbol, symbol),
    with: {
      priceHistory: {
        orderBy: [desc(priceHistory.date)],
        limit: 30,
      },
      watchlistItems: {
        with: {
          watchlist: {
            columns: { id: true, name: true },
          },
        },
      },
    },
  });
}
```

---

## íŠ¸ëœì­ì…˜ ì²˜ë¦¬

### ê¸°ë³¸ íŠ¸ëœì­ì…˜

```typescript
import { sql } from 'drizzle-orm';

async transferStock(
  fromUserId: string, 
  toUserId: string, 
  stockSymbol: string,
  quantity: number,
): Promise<void> {
  await this.db.transaction(async (tx) => {
    // 1. íŒë§¤ì í¬ì§€ì…˜ ê°ì†Œ
    await tx
      .update(positions)
      .set({ 
        quantity: sql`${positions.quantity} - ${quantity}` 
      })
      .where(
        and(
          eq(positions.userId, fromUserId),
          eq(positions.stockSymbol, stockSymbol),
        )
      );

    // 2. êµ¬ë§¤ì í¬ì§€ì…˜ ì¦ê°€ (ì—†ìœ¼ë©´ ìƒì„±)
    await tx
      .insert(positions)
      .values({
        userId: toUserId,
        stockSymbol,
        quantity,
      })
      .onConflictDoUpdate({
        target: [positions.userId, positions.stockSymbol],
        set: { 
          quantity: sql`${positions.quantity} + ${quantity}` 
        },
      });

    // 3. ê±°ë˜ ê¸°ë¡ ìƒì„±
    await tx.insert(transactions).values({
      fromUserId,
      toUserId,
      stockSymbol,
      quantity,
      executedAt: new Date(),
    });
  });
  // íŠ¸ëœì­ì…˜ ë‚´ ì–´ëŠ í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ì „ì²´ ë¡¤ë°±!
}
```

### ğŸ” ì½”ë“œ ë¶„ì„
| ì½”ë“œ | ì„¤ëª… |
|------|------|
| `this.db.transaction(async (tx) => ...)` | ë°ì´í„°ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì½œë°± í•¨ìˆ˜ ë‚´ì˜ ëª¨ë“  ì‘ì—…ì€ ì›ìì (Atomic)ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤. |
| `tx` | íŠ¸ëœì­ì…˜ ë¬¸ë§¥(Context)ì„ ê°€ì§„ Drizzle ì¸ìŠ¤í„´ìŠ¤ì…ë‹ˆë‹¤. íŠ¸ëœì­ì…˜ ë‚´ì—ì„œëŠ” ë°˜ë“œì‹œ `this.db` ëŒ€ì‹  `tx`ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. |
| `sql\`...\`` | ì›ì‹œ(Raw) SQL ì¡°ê°ì„ ìƒì„±í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” `quantity = quantity - 10`ê³¼ ê°™ì€ ì—°ì‚°ì— ì‚¬ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. |
| `.onConflictDoUpdate()` | `UPSERT` (Insert or Update) êµ¬ë¬¸ì„ ìƒì„±í•©ë‹ˆë‹¤. ì¶©ëŒ ë°œìƒ ì‹œ ì—…ë°ì´íŠ¸ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤. |


**íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ê²½ìš°:**
- ì—¬ëŸ¬ í…Œì´ë¸”ì„ ë™ì‹œì— ìˆ˜ì •í•  ë•Œ
- ë°ì´í„° ì¼ê´€ì„±ì´ ì¤‘ìš”í•  ë•Œ (ì†¡ê¸ˆ, ì¬ê³  ê´€ë¦¬ ë“±)
- "ì „ë¶€ ì„±ê³µ ë˜ëŠ” ì „ë¶€ ì‹¤íŒ¨" ë™ì‘ì´ í•„ìš”í•  ë•Œ

---

## Repository íŒ¨í„´ (ì„ íƒì‚¬í•­)

ëŒ€ê·œëª¨ í”„ë¡œì íŠ¸ì—ì„œëŠ” Repository íŒ¨í„´ìœ¼ë¡œ ë°ì´í„° ì ‘ê·¼ ë¡œì§ì„ ë” ë¶„ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Repository í´ë˜ìŠ¤

```typescript
// stocks/stocks.repository.ts
import { Injectable, Inject } from '@nestjs/common';
import { DATABASE_TOKEN, Database } from '../database';
import { stocks, Stock, NewStock } from '@repo/schema';
import { eq, and, gte, lte, like } from 'drizzle-orm';

@Injectable()
export class StocksRepository {
  constructor(
    @Inject(DATABASE_TOKEN) 
    private readonly db: Database,
  ) {}

  // ê¸°ë³¸ CRUD
  findAll() {
    return this.db.query.stocks.findMany();
  }

  findBySymbol(symbol: string) {
    return this.db.query.stocks.findFirst({
      where: eq(stocks.symbol, symbol),
    });
  }

  insert(data: NewStock) {
    return this.db.insert(stocks).values(data).returning();
  }

  // ë³µì¡í•œ ì¿¼ë¦¬ë„ ì—¬ê¸°ì—
  findByPriceRange(minPrice: number, maxPrice: number) {
    return this.db.query.stocks.findMany({
      where: and(
        gte(stocks.currentPrice, minPrice),
        lte(stocks.currentPrice, maxPrice),
      ),
    });
  }

  searchByName(keyword: string) {
    return this.db.query.stocks.findMany({
      where: like(stocks.name, `%${keyword}%`),
    });
  }
}
```

### ì„œë¹„ìŠ¤ì—ì„œ Repository ì‚¬ìš©

```typescript
// stocks/stocks.service.ts
@Injectable()
export class StocksService {
  constructor(
    private readonly stocksRepo: StocksRepository,
    private readonly notificationService: NotificationService,
  ) {}

  async create(data: NewStock): Promise<Stock> {
    const [stock] = await this.stocksRepo.insert(data);
    
    // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ì„œë¹„ìŠ¤ì—
    await this.notificationService.notifyNewStock(stock);
    
    return stock;
  }
}
```

**Repository vs Service:**
- Repository: ìˆœìˆ˜ ë°ì´í„° ì ‘ê·¼ (DB ì¿¼ë¦¬ë§Œ)
- Service: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (ê²€ì¦, ì•Œë¦¼, ìºì‹± ë“±)

---

## ëª¨ë“ˆ ë“±ë¡

```typescript
// stocks/stocks.module.ts
import { Module } from '@nestjs/common';
import { StocksController } from './stocks.controller';
import { StocksService } from './stocks.service';
import { StocksRepository } from './stocks.repository';
// DatabaseModuleì€ @Global()ì´ë¼ import ë¶ˆí•„ìš”

@Module({
  controllers: [StocksController],
  providers: [
    StocksService,
    StocksRepository,  // Repository íŒ¨í„´ ì‚¬ìš© ì‹œ
  ],
  exports: [StocksService],
})
export class StocksModule {}
```

```typescript
// app.module.ts
import { Module } from '@nestjs/common';
import { DatabaseModule } from './database/database.module';
import { StocksModule } from './stocks/stocks.module';
import { UsersModule } from './users/users.module';

@Module({
  imports: [
    DatabaseModule,  // ì „ì—­ ëª¨ë“ˆ
    StocksModule,
    UsersModule,
  ],
})
export class AppModule {}
```

---

---

## ğŸ’¡ ì‹¤ë¬´ íŒ

### 1. Supabase Transaction Mode
Supabaseë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” **Transaction Mode (Port 6543)** ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
Session Mode (Port 5432)ë¥¼ ì‚¬ìš©í•˜ë©´ ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ì—ì„œ ì—°ê²° ìˆ˜ ì œí•œ(Max Connections) ë¬¸ì œë¡œ ì„œë²„ê°€ í„°ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
`DatabaseModule` ì„¤ì •ì—ì„œ `prepare: false` ì˜µì…˜ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.

### 1. ì—°ê²° ìƒíƒœ ì²´í¬

```typescript
// health.controller.ts
export class HealthController {
  constructor(
    @Inject(DATABASE_TOKEN) private readonly db: Database,
  ) {}

  @Get('db')
  async checkDatabase() {
    try {
      await this.db.execute(sql`SELECT 1`);
      return { status: 'ok' };
    } catch (error) {
      throw new ServiceUnavailableException('Database unavailable');
    }
  }
}
```

### 2. ë¡œê¹… ì¶”ê°€

```typescript
const client = postgres(process.env.DATABASE_URL!, {
  debug: (connection, query, params) => {
    console.log('[SQL]', query);
    console.log('[PARAMS]', params);
  },
});
```

---

## í…ŒìŠ¤íŠ¸ (Testing)

ë°ì´í„°ë² ì´ìŠ¤ ì˜ì¡´ì„±ì´ ìˆëŠ” ì„œë¹„ìŠ¤ë¥¼ í…ŒìŠ¤íŠ¸í•  ë•ŒëŠ” `DATABASE_TOKEN`ì„ Mockingí•´ì•¼ í•©ë‹ˆë‹¤.

```typescript
// stocks.service.spec.ts
import { Test, TestingModule } from '@nestjs/testing';
import { StocksService } from './stocks.service';
import { DATABASE_TOKEN } from '../database';

// Mock DB ê°ì²´
const mockDb = {
  query: {
    stocks: {
      findMany: jest.fn(),
      findFirst: jest.fn(),
    },
  },
  insert: jest.fn().mockReturnThis(),
  values: jest.fn().mockReturnThis(),
  returning: jest.fn(),
};

describe('StocksService', () => {
  let service: StocksService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        StocksService,
        {
          provide: DATABASE_TOKEN,
          useValue: mockDb,  // ì‹¤ì œ DB ëŒ€ì‹  Mock ì£¼ì…
        },
      ],
    }).compile();

    service = module.get<StocksService>(StocksService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });

  it('findAllì„ í˜¸ì¶œí•˜ë©´ DBì—ì„œ ì¡°íšŒë¥¼ ìˆ˜í–‰í•´ì•¼ í•¨', async () => {
    mockDb.query.stocks.findMany.mockResolvedValue([]);
    await service.findAll();
    expect(mockDb.query.stocks.findMany).toHaveBeenCalled();
  });
});
```

---

## ë ˆí¼ëŸ°ìŠ¤

- [Drizzle ORM - PostgreSQL](https://orm.drizzle.team/docs/get-started-postgresql)
- [NestJS - Custom Providers](https://docs.nestjs.com/fundamentals/custom-providers)
- [NestJS - Database](https://docs.nestjs.com/techniques/database)

**ë‹¤ìŒ ì¥**: [06. ì¸ì¦ ì²˜ë¦¬](./06-authentication.md)
