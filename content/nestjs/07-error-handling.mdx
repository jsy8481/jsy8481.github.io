---
title: "07. ì—ëŸ¬ ì²˜ë¦¬"
description: "NestJSì˜ ì˜ˆì™¸ í•„í„° ì‹œìŠ¤í…œì„ í†µí•´ ì˜ˆì™¸ë¥¼ ì¼ê´€ë˜ê²Œ ì²˜ë¦¬í•˜ê³ , HTTP ì‘ë‹µìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤."
date: "2026-02-16"
---

## NestJS ì˜ˆì™¸ ì‹œìŠ¤í…œ

### ê°œë…

NestJSëŠ” **ì˜ˆì™¸ í•„í„°(Exception Filter)** ì‹œìŠ¤í…œì„ í†µí•´ ì˜ˆì™¸ë¥¼ ì¼ê´€ë˜ê²Œ ì²˜ë¦¬í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ë‚˜ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì˜ˆì™¸ë¥¼ ë˜ì§€ë©´, ì˜ˆì™¸ í•„í„°ê°€ ì´ë¥¼ ì¡ì•„ HTTP ì‘ë‹µìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.

```
ì„œë¹„ìŠ¤ì—ì„œ ì˜ˆì™¸ ë°œìƒ
       â”‚
       â–¼
ì˜ˆì™¸ í•„í„° (Exception Filter)
       â”‚
       â–¼
HTTP ì‘ë‹µ (ìƒíƒœ ì½”ë“œ + JSON)
```

---

## ë‚´ì¥ HTTP ì˜ˆì™¸

NestJSëŠ” ìì£¼ ì‚¬ìš©ë˜ëŠ” HTTP ìƒíƒœ ì½”ë“œì— ëŒ€í•œ ì˜ˆì™¸ í´ë˜ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

```typescript
import {
  BadRequestException,      // 400 - ì˜ëª»ëœ ìš”ì²­
  UnauthorizedException,    // 401 - ì¸ì¦ í•„ìš”
  ForbiddenException,       // 403 - ê¶Œí•œ ì—†ìŒ
  NotFoundException,        // 404 - ë¦¬ì†ŒìŠ¤ ì—†ìŒ
  ConflictException,        // 409 - ì¶©ëŒ (ì¤‘ë³µ ë“±)
  InternalServerErrorException, // 500 - ì„œë²„ ì˜¤ë¥˜
} from '@nestjs/common';
```

### ì‚¬ìš© ì˜ˆì‹œ

```typescript
@Injectable()
export class UsersService {
  async findOne(id: string) {
    const user = await this.db.query.users.findFirst({
      where: eq(users.id, id),
    });
    
    if (!user) {
      throw new NotFoundException(`ì‚¬ìš©ì ID '${id}'ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
    }
    
    return user;
  }

  async create(dto: CreateUserDto) {
    // ì¤‘ë³µ í™•ì¸
    const existing = await this.db.query.users.findFirst({
      where: eq(users.email, dto.email),
    });
    
    if (existing) {
      throw new ConflictException('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤');
    }
    
    return this.db.insert(users).values(dto).returning();
  }

  async withdraw(userId: string, amount: number) {
    const balance = await this.getBalance(userId);
    
    if (balance < amount) {
      throw new BadRequestException({
        code: 'INSUFFICIENT_BALANCE',
        message: 'ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤',
        balance,
        requested: amount,
      });
    }
    
    // ì¶œê¸ˆ ì²˜ë¦¬
  }
}
```

**ì˜ˆì™¸ ìƒì„±ì ì˜µì…˜:**
- ë¬¸ìì—´: ê°„ë‹¨í•œ ë©”ì‹œì§€
- ê°ì²´: ìƒì„¸ ì •ë³´ (ì½”ë“œ, ì¶”ê°€ ë°ì´í„° ë“±)

---

## ì»¤ìŠ¤í…€ ì˜ˆì™¸

### ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸ í´ë˜ìŠ¤

```typescript
// common/exceptions/business.exception.ts
import { HttpException, HttpStatus } from '@nestjs/common';

export class BusinessException extends HttpException {
  constructor(
    public readonly code: string,
    message: string,
    status: HttpStatus = HttpStatus.BAD_REQUEST,
    public readonly details?: Record<string, any>,
  ) {
    super(
      {
        code,
        message,
        details,
        timestamp: new Date().toISOString(),
      },
      status,
    );
  }
}

// íŠ¹ì • ë„ë©”ì¸ ì˜ˆì™¸
export class StockNotFoundException extends BusinessException {
  constructor(symbol: string) {
    super(
      'STOCK_NOT_FOUND',
      `ì£¼ì‹ '${symbol}'ì„(ë¥¼) ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`,
      HttpStatus.NOT_FOUND,
      { symbol },
    );
  }
}

export class InsufficientBalanceException extends BusinessException {
  constructor(required: number, current: number) {
    super(
      'INSUFFICIENT_BALANCE',
      'ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤',
      HttpStatus.BAD_REQUEST,
      { required, current },
    );
  }
}
```

### ì‚¬ìš©

```typescript
async withdraw(userId: string, amount: number) {
  const balance = await this.getBalance(userId);
  
  if (balance < amount) {
    throw new InsufficientBalanceException(amount, balance);
  }
}
```

### ğŸ” ì½”ë“œ ë¶„ì„
| ì½”ë“œ | ì„¤ëª… |
|------|------|
| `BusinessException` | ëª¨ë“  ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì˜ˆì™¸ì˜ ë¶€ëª¨ í´ë˜ìŠ¤ì…ë‹ˆë‹¤. `HttpException`ì„ ìƒì†ë°›ì•„ HTTP ìƒíƒœ ì½”ë“œì™€ ì‘ë‹µ ë³¸ë¬¸ì„ ì œì–´í•©ë‹ˆë‹¤. |
| `super(...)` | ë¶€ëª¨ í´ë˜ìŠ¤ì˜ ìƒì„±ìë¥¼ í˜¸ì¶œí•˜ì—¬ ì—ëŸ¬ ì‘ë‹µ ê°ì²´(JSON)ì™€ ìƒíƒœ ì½”ë“œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. |
| `StockNotFoundException` | íŠ¹ì • ë„ë©”ì¸(ì£¼ì‹)ì— íŠ¹í™”ëœ ì˜ˆì™¸ í´ë˜ìŠ¤ì…ë‹ˆë‹¤. ì˜ˆì™¸ ë°œìƒ ì‹œ í•„ìš”í•œ ë¬¸ë§¥ ì •ë³´(symbol ë“±)ë¥¼ í•¨ê»˜ ì „ë‹¬í•©ë‹ˆë‹¤. |
| `InsufficientBalanceException` | ì”ì•¡ ë¶€ì¡± ì˜ˆì™¸ì…ë‹ˆë‹¤. í•„ìš”í•œ ê¸ˆì•¡ê³¼ í˜„ì¬ ì”ì•¡ì„ ì—ëŸ¬ ìƒì„¸ ì •ë³´(`details`)ì— í¬í•¨ì‹œí‚µë‹ˆë‹¤. |


---

## ì „ì—­ ì˜ˆì™¸ í•„í„°

### ëª¨ë“  ì˜ˆì™¸ë¥¼ ì¼ê´€ë˜ê²Œ ì²˜ë¦¬

```typescript
// common/filters/http-exception.filter.ts
import {
  ExceptionFilter,
  Catch,
  ArgumentsHost,
  HttpException,
  HttpStatus,
  HttpStatus,
  Logger,
} from '@nestjs/common';
import { HttpAdapterHost } from '@nestjs/core';
import { ZodError } from 'zod'; // Zod ì‚¬ìš© ì‹œ
// import { Request, Response } from 'express'; // ë” ì´ìƒ í•„ìš” ì—†ìŒ (Platform-Agnostic)

@Catch()  // ëª¨ë“  ì˜ˆì™¸ ìºì¹˜
export class GlobalExceptionFilter implements ExceptionFilter {
  private readonly logger = new Logger(GlobalExceptionFilter.name);

  constructor(private readonly httpAdapterHost: HttpAdapterHost) {}

  catch(exception: unknown, host: ArgumentsHost) {
    const { httpAdapter } = this.httpAdapterHost;
    const ctx = host.switchToHttp();

    // 1. ìƒíƒœ ì½”ë“œ ê²°ì •
    let status = HttpStatus.INTERNAL_SERVER_ERROR;
    let errorResponse: any = {
      code: 'INTERNAL_ERROR',
      message: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
    };

    // 2. HttpException ì²˜ë¦¬
    if (exception instanceof HttpException) {
      status = exception.getStatus();
      const exceptionResponse = exception.getResponse();
      
      if (typeof exceptionResponse === 'string') {
        errorResponse = { code: 'ERROR', message: exceptionResponse };
      } else {
        errorResponse = exceptionResponse;
      }
    }
    // 3. Zod ê²€ì¦ ì—ëŸ¬ ì²˜ë¦¬
    else if (exception instanceof ZodError) {
      status = HttpStatus.BAD_REQUEST;
      errorResponse = {
        code: 'VALIDATION_ERROR',
        message: 'ì…ë ¥ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤',
        errors: exception.errors,
      };
    }
    // 4. ì•Œ ìˆ˜ ì—†ëŠ” ì—ëŸ¬
    else {
      this.logger.error(
        `Unhandled exception: ${exception}`,
        (exception as Error).stack,
      );
    }

    // 5. ì‘ë‹µ ì „ì†¡ (Platform-Agnostic)
    const responseBody = {
      ...errorResponse,
      timestamp: new Date().toISOString(),
      path: httpAdapter.getRequestUrl(ctx.getRequest()),
      method: httpAdapter.getRequestMethod(ctx.getRequest()),
    };

    httpAdapter.reply(ctx.getResponse(), responseBody, status);
  }
}
```

### ğŸ” ì½”ë“œ ë¶„ì„
| ì½”ë“œ | ì„¤ëª… |
|------|------|
| `@Catch()` | ì´ í´ë˜ìŠ¤ê°€ **ëª¨ë“  ì˜ˆì™¸** ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•„í„°ì„ì„ ì„ ì–¸í•©ë‹ˆë‹¤. íŠ¹ì • ì˜ˆì™¸ í´ë˜ìŠ¤ë¥¼ ì¸ìë¡œ ë„£ìœ¼ë©´ ê·¸ ì˜ˆì™¸ë§Œ ì²˜ë¦¬í•©ë‹ˆë‹¤. |
| `ArgumentsHost` | ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸(HTTP, RPC, WebSocket ë“±)ë¥¼ ì¶”ìƒí™”í•œ ê°ì²´ì…ë‹ˆë‹¤. `host.switchToHttp()`ë¡œ HTTP ê´€ë ¨ ê°ì²´(Request, Response)ì— ì ‘ê·¼í•©ë‹ˆë‹¤. |
| `instanceof HttpException` | ë°œìƒí•œ ì˜ˆì™¸ê°€ NestJSì˜ í‘œì¤€ HTTP ì˜ˆì™¸ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤. (404, 400 ë“±) |
| `instanceof ZodError` | Zod ê²€ì¦ ì‹¤íŒ¨ ì‹œ ë°œìƒí•˜ëŠ” ì—ëŸ¬ë¥¼ ë³„ë„ë¡œ ì²˜ë¦¬í•˜ì—¬ ìƒì„¸í•œ ê²€ì¦ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ì‘ë‹µì— í¬í•¨ì‹œí‚µë‹ˆë‹¤. |
| `httpAdapter.reply()` | ê¸°ë³¸ HTTP ì–´ëŒ‘í„°(Express ë˜ëŠ” Fastify)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‘ë‹µì„ ë³´ëƒ…ë‹ˆë‹¤. íŠ¹ì • í”„ë ˆì„ì›Œí¬ì— ì¢…ì†ë˜ì§€ ì•ŠëŠ” ì½”ë“œë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. |


### ë“±ë¡ (HttpAdapterHost ì£¼ì… í•„ìš”)

```typescript
// main.ts
import { HttpAdapterHost } from '@nestjs/core';
import { GlobalExceptionFilter } from './common/filters/http-exception.filter';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  
  const httpAdapterHost = app.get(HttpAdapterHost);
  app.useGlobalFilters(new GlobalExceptionFilter(httpAdapterHost));
  
  await app.listen(3001);
}
```

---

## ë¡œê¹…

### JSON ë¡œê¹… (ìš´ì˜ í™˜ê²½)

ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ë¡œê·¸ë¥¼ êµ¬ì¡°í™”ëœ JSON í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•˜ì—¬ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ(AWS CloudWatch, ElasticSearch ë“±)ê³¼ ì—°ë™í•˜ê¸° ì‰½ê²Œ ë§Œë“œëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

```typescript
// main.ts
const app = await NestFactory.create(AppModule, {
  logger: process.env.NODE_ENV === 'production' 
    ? ['error', 'warn', 'log'] 
    : ['error', 'warn', 'log', 'debug', 'verbose'],
});

// ë˜ëŠ” ì»¤ìŠ¤í…€ ë¡œê±° ì„¤ì •
// app.useLogger(app.get(MyLogger));


### ì¼ê´€ëœ ì‘ë‹µ êµ¬ì¡°

```typescript
// ëª¨ë“  ì—ëŸ¬ ì‘ë‹µì´ ì´ í˜•ì‹ì„ ë”°ë¦„
interface ErrorResponse {
  code: string;          // ì—ëŸ¬ ì½”ë“œ (í”„ë¡ íŠ¸ì—”ë“œ ë¶„ê¸°ìš©)
  message: string;        // ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€
  details?: object;       // ì¶”ê°€ ì •ë³´
  errors?: ValidationError[]; // ê²€ì¦ ì—ëŸ¬ ëª©ë¡
  timestamp: string;      // ë°œìƒ ì‹œê°„
  path: string;           // ìš”ì²­ ê²½ë¡œ
  method: string;         // HTTP ë©”ì„œë“œ
}

// ì˜ˆì‹œ ì‘ë‹µ
{
  "code": "STOCK_NOT_FOUND",
  "message": "ì£¼ì‹ 'INVALID'ì„(ë¥¼) ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
  "details": { "symbol": "INVALID" },
  "timestamp": "2024-01-15T10:30:00.000Z",
  "path": "/api/stocks/INVALID",
  "method": "GET"
}
```

### í”„ë¡ íŠ¸ì—”ë“œ ì—ëŸ¬ ì²˜ë¦¬

```typescript
// í”„ë¡ íŠ¸ì—”ë“œì—ì„œ
try {
  await stocksApi.getBySymbol('INVALID');
} catch (error) {
  if (error.response?.data?.code === 'STOCK_NOT_FOUND') {
    // íŠ¹ì • ì—ëŸ¬ ì²˜ë¦¬
    showNotFound();
  } else if (error.response?.data?.code === 'VALIDATION_ERROR') {
    // ê²€ì¦ ì—ëŸ¬ ì²˜ë¦¬
    const errors = error.response.data.errors;
    showFormErrors(errors);
  } else {
    // ì¼ë°˜ ì—ëŸ¬
    showGenericError(error.response?.data?.message);
  }
}
```

---

---

## ë¡œê¹… ì „ëµ (Logging Strategy)

### ì—ëŸ¬ ë¡œê¹… ì „ëµ

```typescript
catch(exception: unknown, host: ArgumentsHost) {
  // 500 ì—ëŸ¬ëŠ” ìƒì„¸ ë¡œê¹…
  if (status >= 500) {
    this.logger.error(
      `[${request.method}] ${request.url}`,
      {
        body: request.body,
        query: request.query,
        user: request.user?.id,
        stack: (exception as Error).stack,
      },
    );
  }
  // 400ëŒ€ ì—ëŸ¬ëŠ” ê°„ë‹¨íˆ
  else {
    this.logger.warn(
      `[${request.method}] ${request.url} - ${errorResponse.code}`,
    );
  }
}
```

---

---

## ğŸ’¡ ì‹¤ë¬´ íŒ

### 3. ì‹¬ê°í•œ ì—ëŸ¬ ì•Œë¦¼ (Slack/Email)
500 ì—ëŸ¬(Internal Server Error)ëŠ” ê°œë°œìê°€ ì¦‰ì‹œ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤.
Global Filterì—ì„œ 500 ì—ëŸ¬ ë°œìƒ ì‹œ Slack ë“±ìœ¼ë¡œ ì•Œë¦¼ì„ ë³´ë‚´ë„ë¡ ì„¤ì •í•˜ì„¸ìš”.

```typescript
// filter ë‚´ì—ì„œ
if (status === HttpStatus.INTERNAL_SERVER_ERROR) {
  await this.slackService.sendAlert({
    text: `ğŸš¨ ì„œë²„ ì—ëŸ¬ ë°œìƒ! \n Path: ${request.url} \n Error: ${exception.message}`,
  });
}
```

### 1. ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì—ëŸ¬ ì²˜ë¦¬ ìµœì†Œí™”

```typescript
// âŒ ë‚˜ìœ ì˜ˆ: ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì—ëŸ¬ ì²˜ë¦¬
@Get(':id')
async findOne(@Param('id') id: string) {
  try {
    const user = await this.usersService.findOne(id);
    if (!user) {
      throw new NotFoundException();
    }
    return user;
  } catch (error) {
    // ì—ëŸ¬ ì²˜ë¦¬ ë¡œì§
  }
}

// âœ… ì¢‹ì€ ì˜ˆ: ì„œë¹„ìŠ¤ì—ì„œ ì˜ˆì™¸ ë˜ì§€ê¸°
@Get(':id')
findOne(@Param('id') id: string) {
  return this.usersService.findOne(id);
  // ì„œë¹„ìŠ¤ì—ì„œ NotFoundException ë˜ì§
  // ì „ì—­ í•„í„°ê°€ ì²˜ë¦¬
}
```

### 2. ì—ëŸ¬ ì½”ë“œ ìƒìˆ˜í™”

```typescript
// common/error-codes.ts
export const ErrorCodes = {
  // ì¸ì¦
  AUTH_TOKEN_EXPIRED: 'AUTH_TOKEN_EXPIRED',
  AUTH_INVALID_TOKEN: 'AUTH_INVALID_TOKEN',
  
  // ì‚¬ìš©ì
  USER_NOT_FOUND: 'USER_NOT_FOUND',
  USER_EMAIL_EXISTS: 'USER_EMAIL_EXISTS',
  
  // ì£¼ì‹
  STOCK_NOT_FOUND: 'STOCK_NOT_FOUND',
  STOCK_SYMBOL_EXISTS: 'STOCK_SYMBOL_EXISTS',
  
  // ì¼ë°˜
  VALIDATION_ERROR: 'VALIDATION_ERROR',
  INTERNAL_ERROR: 'INTERNAL_ERROR',
} as const;
```

---

## ë ˆí¼ëŸ°ìŠ¤

- [NestJS - Exception Filters](https://docs.nestjs.com/exception-filters)
- [NestJS - Built-in HTTP Exceptions](https://docs.nestjs.com/exception-filters#built-in-http-exceptions)
- [HTTP Status Codes](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status)
